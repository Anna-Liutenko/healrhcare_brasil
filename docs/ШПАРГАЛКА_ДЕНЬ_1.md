# üìù –®–ü–ê–†–ì–ê–õ–ö–ê: –î–µ–Ω—å 1 - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏ Entities

**–≠—Ç–∞–ø 5, –î–µ–Ω—å 1/12**  
**–ó–∞–¥–∞—á–∞:** –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ PHP Entities –¥–ª—è inline-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## ‚úÖ –®–ê–ì 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

### –ö–æ–º–∞–Ω–¥–∞ (PowerShell):

```powershell
# –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
cd "C:\Users\annal\Documents\–ú–æ–∏ —Å–∞–π—Ç—ã\–°–∞–π—Ç –æ –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë—Ä–∞–∑–∏–ª–∏–∏\–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞ —Å CMS"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
mysql -u root -p healthcare_cms < "database\migrations\010_add_inline_editing_fields.sql"

# –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å MySQL (–æ–±—ã—á–Ω–æ –ø—É—Å—Ç–æ–π –∏–ª–∏ "root")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ (MySQL):

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
mysql -u root -p healthcare_cms

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã pages
DESCRIBE pages;
-- –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –ø–æ–ª—è:
-- visibility ENUM('public', 'unlisted', 'private')
-- archived_at DATETIME NULL
-- last_edited_by CHAR(36) NULL

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã blocks
DESCRIBE blocks;
-- –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –ø–æ–ª—è:
-- is_editable BOOLEAN
-- editable_fields JSON NULL

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
SHOW INDEX FROM pages;

-- –í—ã–π—Ç–∏
exit;
```

---

## ‚úÖ –®–ê–ì 2: –û–±–Ω–æ–≤–∏—Ç—å PHP Entity Page

**–§–∞–π–ª:** `backend/src/Domain/Page.php`

### –ù–∞–π—Ç–∏:

```php
private string $createdBy;
```

### –î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï:

```php
private ?string $lastEditedBy;   // ‚≠ê NEW
```

### –ù–∞–π—Ç–∏:

```php
private ?DateTime $publishedAt;
```

### –î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï:

```php
private ?DateTime $archivedAt;   // ‚≠ê NEW
```

### –ù–∞–π—Ç–∏:

```php
private string $status;
```

### –î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï:

```php
private string $visibility;      // ‚≠ê NEW
```

### –î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ç—Ç–µ—Ä—ã –∏ —Å–µ—Ç—Ç–µ—Ä—ã:

```php
public function getVisibility(): string
{
    return $this->visibility;
}

public function setVisibility(string $visibility): void
{
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    $allowedVisibilities = ['public', 'unlisted', 'private'];
    if (!in_array($visibility, $allowedVisibilities)) {
        throw new \InvalidArgumentException(
            "Invalid visibility. Allowed: " . implode(', ', $allowedVisibilities)
        );
    }
    $this->visibility = $visibility;
}

public function getArchivedAt(): ?DateTime
{
    return $this->archivedAt;
}

public function setArchivedAt(?DateTime $archivedAt): void
{
    $this->archivedAt = $archivedAt;
}

public function getLastEditedBy(): ?string
{
    return $this->lastEditedBy;
}

public function setLastEditedBy(?string $lastEditedBy): void
{
    $this->lastEditedBy = $lastEditedBy;
}
```

---

## ‚úÖ –®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç—å PHP Entity Block

**–§–∞–π–ª:** `backend/src/Domain/Block.php`

### –ù–∞–π—Ç–∏:

```php
private array $data;
```

### –î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï:

```php
private bool $isEditable;        // ‚≠ê NEW
private array $editableFields;   // ‚≠ê NEW
```

### –î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ç—Ç–µ—Ä—ã –∏ —Å–µ—Ç—Ç–µ—Ä—ã:

```php
public function isEditable(): bool
{
    return $this->isEditable;
}

public function setIsEditable(bool $isEditable): void
{
    $this->isEditable = $isEditable;
}

public function getEditableFields(): array
{
    return $this->editableFields;
}

public function setEditableFields(array $editableFields): void
{
    $this->editableFields = $editableFields;
}
```

---

## ‚úÖ –®–ê–ì 4: –û–±–Ω–æ–≤–∏—Ç—å MySQLPageRepository

**–§–∞–π–ª:** `backend/src/Infrastructure/MySQLPageRepository.php`

### –í –º–µ—Ç–æ–¥–µ `save()` –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è:

```php
public function save(Page $page): void
{
    $sql = "INSERT INTO pages (
        id, title, slug, status, visibility, type, 
        seo, tracking, created_at, updated_at, 
        published_at, archived_at, created_by, last_edited_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ON DUPLICATE KEY UPDATE
        title = VALUES(title),
        slug = VALUES(slug),
        status = VALUES(status),
        visibility = VALUES(visibility),
        type = VALUES(type),
        seo = VALUES(seo),
        tracking = VALUES(tracking),
        updated_at = VALUES(updated_at),
        published_at = VALUES(published_at),
        archived_at = VALUES(archived_at),
        last_edited_by = VALUES(last_edited_by)";

    $stmt = $this->db->prepare($sql);
    $stmt->execute([
        $page->getId(),
        $page->getTitle(),
        $page->getSlug(),
        $page->getStatus(),
        $page->getVisibility(),        // ‚≠ê NEW
        $page->getType(),
        json_encode($page->getSeo()),
        json_encode($page->getTracking()),
        $page->getCreatedAt()->format('Y-m-d H:i:s'),
        $page->getUpdatedAt()->format('Y-m-d H:i:s'),
        $page->getPublishedAt()?->format('Y-m-d H:i:s'),
        $page->getArchivedAt()?->format('Y-m-d H:i:s'),  // ‚≠ê NEW
        $page->getCreatedBy(),
        $page->getLastEditedBy()       // ‚≠ê NEW
    ]);
}
```

### –í –º–µ—Ç–æ–¥–µ `findById()` –¥–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥:

```php
public function findById(string $id): ?Page
{
    $sql = "SELECT * FROM pages WHERE id = ?";
    $stmt = $this->db->prepare($sql);
    $stmt->execute([$id]);
    $row = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$row) {
        return null;
    }

    $page = new Page(
        id: $row['id'],
        title: $row['title'],
        slug: $row['slug'],
        status: $row['status'],
        visibility: $row['visibility'],        // ‚≠ê NEW
        type: $row['type'],
        seo: json_decode($row['seo'], true),
        tracking: json_decode($row['tracking'], true),
        createdAt: new DateTime($row['created_at']),
        updatedAt: new DateTime($row['updated_at']),
        publishedAt: $row['published_at'] ? new DateTime($row['published_at']) : null,
        archivedAt: $row['archived_at'] ? new DateTime($row['archived_at']) : null,  // ‚≠ê NEW
        createdBy: $row['created_by'],
        lastEditedBy: $row['last_edited_by']  // ‚≠ê NEW
    );

    return $page;
}
```

---

## ‚úÖ –®–ê–ì 5: –û–±–Ω–æ–≤–∏—Ç—å MySQLBlockRepository

**–§–∞–π–ª:** `backend/src/Infrastructure/MySQLBlockRepository.php`

### –í –º–µ—Ç–æ–¥–µ `save()`:

```php
public function save(Block $block): void
{
    $sql = "INSERT INTO blocks (
        id, page_id, type, position, custom_name, data, is_editable, editable_fields
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ON DUPLICATE KEY UPDATE
        type = VALUES(type),
        position = VALUES(position),
        custom_name = VALUES(custom_name),
        data = VALUES(data),
        is_editable = VALUES(is_editable),
        editable_fields = VALUES(editable_fields)";

    $stmt = $this->db->prepare($sql);
    $stmt->execute([
        $block->getId(),
        $block->getPageId(),
        $block->getType(),
        $block->getPosition(),
        $block->getCustomName(),
        json_encode($block->getData()),
        $block->isEditable(),                                    // ‚≠ê NEW
        json_encode($block->getEditableFields())                // ‚≠ê NEW
    ]);
}
```

### –í –º–µ—Ç–æ–¥–µ `findByPageId()`:

```php
public function findByPageId(string $pageId): array
{
    $sql = "SELECT * FROM blocks WHERE page_id = ? ORDER BY position ASC";
    $stmt = $this->db->prepare($sql);
    $stmt->execute([$pageId]);
    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

    $blocks = [];
    foreach ($rows as $row) {
        $blocks[] = new Block(
            id: $row['id'],
            pageId: $row['page_id'],
            type: $row['type'],
            position: $row['position'],
            customName: $row['custom_name'],
            data: json_decode($row['data'], true),
            isEditable: (bool)$row['is_editable'],                      // ‚≠ê NEW
            editableFields: json_decode($row['editable_fields'], true) ?: []  // ‚≠ê NEW
        );
    }

    return $blocks;
}
```

---

## ‚úÖ –®–ê–ì 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß–µ—Ä–µ–∑ MySQL:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–∏–ª–∏—Å—å
SELECT id, title, status, visibility, archived_at, last_edited_by 
FROM pages 
LIMIT 3;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å blocks
SELECT id, type, is_editable, editable_fields 
FROM blocks 
WHERE editable_fields IS NOT NULL 
LIMIT 3;
```

### –ß–µ—Ä–µ–∑ API (Postman –∏–ª–∏ curl):

```bash
# –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
curl -X POST http://localhost/healthcare-cms-backend/public/api/pages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "title": "–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
    "slug": "test-page",
    "status": "draft",
    "visibility": "public",
    "type": "regular",
    "seo": {},
    "tracking": {},
    "blocks": []
  }'

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
curl http://localhost/healthcare-cms-backend/public/api/pages/PAGE_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢ –î–ù–Ø 1:

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ —É —Ç–µ–±—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

‚úÖ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ pages –∏ blocks)  
‚úÖ PHP Entities –æ–±–Ω–æ–≤–ª–µ–Ω—ã (Page, Block)  
‚úÖ Repositories —Ä–∞–±–æ—Ç–∞—é—Ç —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏  
‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–∏–ª–∏ visibility = 'public'  
‚úÖ –í—Å–µ –±–ª–æ–∫–∏ –ø–æ–ª—É—á–∏–ª–∏ is_editable = TRUE –∏ editable_fields

---

## üìö –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´:

```powershell
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ XAMPP MySQL –∑–∞–ø—É—â–µ–Ω
netstat -ano | findstr :3306

# –ó–∞–ø—É—Å—Ç–∏—Ç—å MySQL
C:\xampp\mysql\bin\mysql.exe -u root -p

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ PHP
type C:\xampp\htdocs\healthcare-cms-backend\public\php-server.log

# –û—Ç–∫—Ä—ã—Ç—å Visual Editor
Start-Process "http://localhost/visual-editor-standalone/"
```

---

**–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å:** Use Cases (ArchivePage, RestorePage, ChangePageVisibility...)
