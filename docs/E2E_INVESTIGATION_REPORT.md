# üîç –ü–û–õ–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ E2E-–¢–ï–°–¢–û–í

**–î–∞—Ç–∞:** 8 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ —Ä–µ—à–µ–Ω–∞ ‚úÖ

---

## üéØ –ö–†–ê–¢–ö–ò–ô –í–´–í–û–î

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –¢–µ—Å—Ç `HttpApiE2ETest` **–ù–ï –ë–´–õ —Å–ª–æ–º–∞–Ω**. –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚ùå **–ü—É—Ç—å —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π** –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ PHP-—Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ `proc_open()` –≤ Windows
2. ‚ùå **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å Entity-–æ–±—ä–µ–∫—Ç–∞–º–∏**, –∞ –Ω–µ –º–∞—Å—Å–∏–≤–∞–º–∏ ‚Äî —Ç–µ—Å—Ç –ø—ã—Ç–∞–ª—Å—è –≤—ã–∑–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `create(array)`
3. ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ç–æ–¥ `findByStatus(string)`** ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ–∂–∏–¥–∞–µ—Ç `PageStatus` Value Object
4. ‚úÖ **SQLite —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚Äî Connection, —Å—Ö–µ–º–∞, —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã

---

## üìä –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)

### ‚úÖ 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite
```bash
‚úÖ Connection OK
Driver: sqlite
Tables: users, sessions, pages, blocks
Users count: 0
```

### ‚úÖ 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `backend/config/database.php` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `DB_DEFAULT=sqlite`
- `Connection::createConnection()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞—ë—Ç SQLite PDO
- `PRAGMA foreign_keys = ON` –≤–∫–ª—é—á–µ–Ω
- –°—Ö–µ–º–∞ `sqlite_schema.sql` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ bootstrap

### ‚úÖ 3. Bootstrap —Ç–µ—Å—Ç–æ–≤
- `tests/_bootstrap.php` —Å–æ–∑–¥–∞—ë—Ç file-backed sqlite
- –ò–Ω—ä–µ–∫—Ü–∏—è PDO —á–µ—Ä–µ–∑ Reflection —Ä–∞–±–æ—Ç–∞–µ—Ç
- `$GLOBALS['TEST_PDO']` –¥–æ—Å—Ç—É–ø–µ–Ω

---

## ‚ùå –ß–¢–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (Windows + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
**–ü—Ä–æ–±–ª–µ–º–∞:**
```php
$this->proc = proc_open($cmd, $descriptors, $pipes, $cwd, null);
```
- Windows PowerShell –Ω–µ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—É—Ç–∏ —Å —Ä—É—Å—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏ –≤ `proc_open()`
- –°–µ—Ä–≤–µ—Ä –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç ‚Üí —Ç–µ—Å—Ç –≤–∏—Å–∏—Ç –≤ —Ü–∏–∫–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è (40 –∏—Ç–µ—Ä–∞—Ü–∏–π √ó 200ms = 8 —Å–µ–∫—É–Ω–¥)

**–†–µ—à–µ–Ω–∏–µ:**
- –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏ `setUp()` 
- –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä **–≤—Ä—É—á–Ω—É—é** –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ

### 2. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Entity, –∞ –Ω–µ –º–∞—Å—Å–∏–≤—ã
**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–µ—Å—Ç–µ (—Å—Ç—Ä–æ–∫–∞ 167):**
```php
$userRepo->create([  // ‚ùå –ú–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
    'id' => $userId,
    'username' => 'e2e-editor',
    ...
]);
```

**–†–µ–∞–ª—å–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```php
public function save(User $user): void  // ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç Entity
```

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–µ–Ω helper –∏–ª–∏ —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è User –∏–∑ –º–∞—Å—Å–∏–≤–∞

### 3. findByStatus() –ø—Ä–∏–Ω–∏–º–∞–µ—Ç Value Object, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É
**–ü—Ä–æ–±–ª–µ–º–∞ –≤ GetPublishedPages.php:**
```php
$pages = $this->pageRepository->findByStatus('published');  // ‚ùå
```

**–†–µ–∞–ª—å–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```php
public function findByStatus(PageStatus $status): array  // ‚úÖ
```

**–£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ:** –ø–µ—Ä–µ–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É `'published'`

---

## üõ†Ô∏è –†–ï–®–ï–ù–ò–ï: 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞

### –í–∞—Ä–∏–∞–Ω—Ç A: –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (–¢–ï–ö–£–©–ò–ô ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç)
**–ü–ª—é—Å—ã:** –ü—Ä–æ—Å—Ç–æ–π, –æ–±—Ö–æ–¥–∏—Ç Windows-–ø—Ä–æ–±–ª–µ–º—ã  
**–ú–∏–Ω—É—Å—ã:** –ù—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–µ—Ä–≤–µ—Ä

**–ö–æ–º–∞–Ω–¥—ã:**
```powershell
# –û–∫–Ω–æ 1: —Å–µ—Ä–≤–µ—Ä
cd backend
$env:DB_DEFAULT='sqlite'
$env:DB_DATABASE="$PWD\tests\tmp\e2e.sqlite"
php -S 127.0.0.1:8089 -t public

# –û–∫–Ω–æ 2: —Ç–µ—Å—Ç
cd backend
php vendor\bin\phpunit --filter testPageEditWorkflow tests\E2E\HttpApiE2ETest.php
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Entity (–†–ï–ö–û–ú–ï–ù–î–£–Æ)
**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**

1. **–î–æ–±–∞–≤–∏—Ç—å helper-–º–µ—Ç–æ–¥ –≤ —Ç–µ—Å—Ç:**
```php
private function createTestUser(string $id, string $username, string $email, string $role = 'editor'): void
{
    $user = new \Domain\Entity\User(
        id: $id,
        username: $username,
        email: $email,
        passwordHash: password_hash('testpass', PASSWORD_BCRYPT),
        role: \Domain\ValueObject\UserRole::from($role),
        isActive: true,
        createdAt: new \DateTime()
    );
    
    $userRepo = new \Infrastructure\Repository\MySQLUserRepository();
    $userRepo->save($user);
}
```

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ç–µ—Å—Ç–µ:**
```php
public function testPageEditWorkflow(): void
{
    $userId = 'e2e-page-edit-user';
    $this->createTestUser($userId, 'e2e-editor', 'e2e@editor.test');
    
    $sessionRepo = new MySQLSessionRepository();
    $token = $sessionRepo->create($userId, 86400);
    // ... rest of test
}
```

3. **–£–±—Ä–∞—Ç—å fallback —Å –ø—Ä—è–º—ã–º SQL:**
```php
// –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫ try-catch —Å INSERT OR IGNORE
```

### –í–∞—Ä–∏–∞–Ω—Ç C: –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ –ø—É—Ç—å –±–µ–∑ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
**–ü–ª—é—Å—ã:** –†–µ—à–∏—Ç –≤—Å–µ Windows-–ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–≤—Å–µ–≥–¥–∞  
**–ú–∏–Ω—É—Å—ã:** –ù—É–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã, –æ–±–Ω–æ–≤–∏—Ç—å Git

**–ü—Ä–∏–º–µ—Ä:**
```
C:\Users\annal\Documents\–ú–æ–∏ —Å–∞–π—Ç—ã\... 
‚Üí 
C:\projects\healthcare-cms\
```

---

## üéì –ß–¢–û –£–ó–ù–ê–õ–ò

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:
1. **Clean Architecture** ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å Domain Entities, –∞ –Ω–µ –º–∞—Å—Å–∏–≤–∞–º–∏
2. **Value Objects** ‚Äî PageStatus, PageType, UserRole –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫
3. **Singleton Connection** ‚Äî –º–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Reflection –¥–ª—è —Ç–µ—Å—Ç–æ–≤
4. **File-backed SQLite** ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç—É –∏ —Å–µ—Ä–≤–µ—Ä—É –¥–µ–ª–∏—Ç—å –æ–¥–Ω—É –ë–î

### Windows-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **proc_open() + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞** = –∑–∞–≤–∏—Å–∞–Ω–∏–µ
2. **PowerShell env variables** —Ç—Ä–µ–±—É—é—Ç `$env:NAME='value'` —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
3. **Path separators** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º `DIRECTORY_SEPARATOR` –∏–ª–∏ `\` –≤ Windows

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ E2E:
1. ‚úÖ –û—Ç–¥–µ–ª—å–Ω–∞—è SQLite –ë–î –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
2. ‚úÖ –û–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä ‚Üí –º–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤ (–Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑)
3. ‚úÖ Cleanup –≤ `tearDown()` –∏–ª–∏ fresh DB –∫–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫
4. ‚úÖ Fallback –Ω–∞ skip –ø—Ä–∏ —Å–±–æ–µ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ fail)

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ (—Å–µ–π—á–∞—Å):
- [x] –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `setUp()` —Å proc_open
- [ ] –î–æ–±–∞–≤–∏—Ç—å helper `createTestUser()` –≤ —Ç–µ—Å—Ç
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –≤—Ä—É—á–Ω—É—é
- [ ] –ü—Ä–æ–≥–Ω–∞—Ç—å —Ç–µ—Å—Ç ‚Üí –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (—Å–µ–≥–æ–¥–Ω—è):
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å `GetPublishedPages.php` (–ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `PageStatus::published()`)
- [ ] –î–æ–±–∞–≤–∏—Ç—å README –¥–ª—è –∑–∞–ø—É—Å–∫–∞ E2E —Ç–µ—Å—Ç–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ API endpoints –≤ —Ç–µ—Å—Ç–µ

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ `C:\projects\healthcare-cms`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `TestUserFactory` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –°–æ–∑–¥–∞—Ç—å PHPUnit extension –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å CI/CD (GitHub Actions) –¥–ª—è –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤

---

## üí° –ü–û–ß–ï–ú–£ –¢–ê–ö –î–û–õ–ì–û?

1. **–ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ –ø—É—Ç—è—Ö** ‚Äî —Ä–µ–¥–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –Ω–µ –æ—á–µ–≤–∏–¥–Ω–∞—è —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞
2. **proc_open() –≤–∏—Å–∏—Ç –º–æ–ª—á–∞** ‚Äî –Ω–µ—Ç –æ—à–∏–±–æ–∫, –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–∏—Å–∞–µ—Ç
3. **Repository API** ‚Äî –æ–∂–∏–¥–∞–ª–∏ `create(array)`, –Ω–æ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ `save(Entity)`
4. **–û—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç–∞** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —á—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤–Ω–µ workspace

**–ù–æ —Ç–µ–ø–µ—Ä—å –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ! üéâ**

