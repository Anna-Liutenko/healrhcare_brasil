# История дебага: проблема с сохранением блоков в CMS (октябрь 2025)

## Введение
В октябре 2025 года была обнаружена проблема: при сохранении страницы через CMS блоки не сохранялись, несмотря на успешный ответ (200 OK) от API. Ниже приведена подробная история поиска и устранения этой ошибки.

> NOTE: Визуальная возможность переименовывать блоки (UI rename) была исключена из редактора — поле `custom_name` остаётся в API/БД для совместимости и импорта, но в админке переименование блоков недоступно.

---

## 1. Симптомы
- При создании или обновлении страницы через редактор CMS блоки не сохранялись в базе данных.
- API возвращал 200 OK, но после обновления страницы блоки исчезали.

## 2. Диагностика
### 2.1 Проверка фронтенда
- Проверили, что payload с блоками уходит на сервер корректно (через devtools и консоль).
- Убедились, что структура данных соответствует API_CONTRACT.md.

### 2.2 Проверка бэкенда
- Изучили код backend/src/Application/UseCase/UpdatePage.php.
- Обнаружили, что метод execute() не сохраняет блоки при обновлении страницы (PUT-запрос).
- Проверили работу репозитория блоков (MySQLBlockRepository.php).

### 2.3 Проверка БД
- Использовали скрипт backend/scripts/check_blocks.php для просмотра количества блоков на странице до и после обновления.

---

## 3. Исправление
- В UpdatePage.php добавили логику: при обновлении страницы теперь сначала удаляются старые блоки, затем вставляются новые из payload.
- Добавили поддержку обоих вариантов ключей: customName и custom_name.

---

## 4. Верификация
- Провели тесты через PowerShell:
    - Проверили синтаксис PHP-файлов (php -l).
    - Синхронизировали изменения на XAMPP.
    - Проверили состояние БД через check_blocks.php.
- Провели ручные тесты через UI редактора: блоки сохраняются и отображаются корректно.

---

## 5. Итог
- Баг устранён: блоки теперь сохраняются при создании и обновлении страниц.
- В процессе обнаружили дублирование frontend-папок на сервере (одна — симлинк, вторая — копия). Принято решение работать только с симлинком (standalone).

---

## 6. Рекомендации
- Для предотвращения подобных багов: покрыть use case тестами, добавить логирование ошибок сохранения блоков.
- Для деплоя фронтенда использовать только одну актуальную папку (симлинк).

---

## 7. Приложения
- Скрипты для проверки блоков: backend/scripts/check_blocks.php
- Основные файлы:
    - backend/src/Application/UseCase/UpdatePage.php
    - backend/src/Infrastructure/Persistence/MySQLBlockRepository.php
    - frontend/utils/mappers.js

---

_Документ подготовлен автоматически на основе истории дебага проекта._
