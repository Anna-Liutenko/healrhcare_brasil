Решение проблемы: медиатека (папка uploads) удаляется при синхронизации с XAMPP
=================================================================

Краткое резюме
--------------
При обновлении кода через локальный скрипт `sync-to-xampp.ps1` наблюдалась проблема: загруженные пользователем изображения (в `backend/public/uploads/`) становились недоступны — в браузере отображались только названия или сломанные ссылки. Причина — команда `robocopy /MIR` в скрипте зеркалировала содержимое репозитория в папку XAMPP и удаляла файлы в целевой папке `uploads`, если в репозитории эти файлы отсутствовали.

Цель исправления
----------------
1. Предотвратить удаление user-generated content (папка `uploads`) при синхронизации.
2. Добавить простое логирование в процесс синхронизации и возможность dry-run.
3. Автоматически запускать проверку расхождений БД ↔ ФС (через существующий скрипт `backend/scripts/cleanup-missing-media.php --dry-run`) и записывать результат в лог.
4. Обеспечить безопасное «первичное создание» целевых папок `uploads` на XAMPP, если они отсутствуют.

Файлы, изменённые в рамках исправления
--------------------------------------
- `sync-to-xampp.ps1` — основной скрипт синхронизации.
  - Добавлено исключение `/XD "uploads"` для команды `robocopy`.
  - Добавлен параметр `-DryRun` (имитация без копирования — использует `/L`).
  - Добавлена функция логирования `Write-Log` (лог-файл `sync-to-xampp.log` в корне репозитория).
  - Перед запуском robocopy логируются аргументы и затем записывается код возврата (exit code).
  - После синхронизации: подсчёт файлов в `backendTarget\public\uploads` и запуск `backend/scripts/cleanup-missing-media.php --dry-run` (если найден `php`), вывод скрипта записывается в лог.
  - При отсутствии целевых `uploads` на XAMPP скрипт создаёт папки, чтобы предотвратить 404.

Root cause (корень проблемы)
---------------------------
- `robocopy /MIR` выполняет зеркалирование и удаляет файлы в целевой директории, если их нет в источнике.
- В проекте `uploads/` содержит user-generated content и не должен быть частью «источника правды» репозитория.
- В репозитории папка `uploads/` не наполняется пользовательскими файлами, поэтому при зеркалировании содержимое целевой папки удалялось.

Описание выполненного исправления
----------------------------------
1. Исключение папки `uploads` в `robocopy` с помощью `/XD "uploads"`. Это предотвращает удаление содержимого целевой папки при зеркалировании.
2. Добавление флага `-DryRun` к `sync-to-xampp.ps1` для безопасной проверки действий `robocopy` (он добавляет `/L` — режим списка действий).
3. Добавление логирования (файл `sync-to-xampp.log`) с временными метками и уровнями (INFO/WARN/ERROR).
4. Создание целевых папок `uploads`, если их не существует, чтобы исключение не приводило к отсутствию папки и 404.
5. Пост-синхронизационная проверка: подсчёт файлов в целевой папке и запуск `backend/scripts/cleanup-missing-media.php --dry-run` (если в системе доступен PHP). Это позволяет быстро увидеть расхождения между таблицей `media` в БД и реальным набором файлов.

Как работать с новым скриптом (инструкция)
------------------------------------------
1) Dry-run (без фактического копирования, безопасно):

```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\sync-to-xampp.ps1 -DryRun
```

- Скрипт выполнит симуляцию robocopy (аргументы будут логироваться), создаст/проверит папки `uploads` на целевых путях и выполнит пост-проверки (подсчёт файлов, попытку запустить `cleanup-missing-media.php --dry-run`).
- Вывод также пишется в `sync-to-xampp.log`.

2) Полный прогон (выполнит копирование, но не удалит `uploads`):

```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\sync-to-xampp.ps1
```

3) Где смотреть лог:
- `sync-to-xampp.log` в корне репозитория. Содержит временные метки, аргументы robocopy, exit codes и (при наличии) вывод `cleanup-missing-media.php --dry-run`.

4) Если хотите вручную запустить сравнение БД ↔ файловой системы (без запуска всего sync):

```powershell
# При наличии php в PATH (или указать путь к php.exe из XAMPP)
php backend\scripts\cleanup-missing-media.php --dry-run
```

Пояснения по использованию `cleanup-missing-media.php`
-----------------------------------------------------
- Скрипт предназначен для поиска записей в таблице `media`, для которых физические файлы отсутствуют, и (при обычном режиме) удаления таких записей.
- Флаг `--dry-run` выводит список таких несоответствий, но ничего не удаляет — используйте его сначала для диагностики.

QA / Проверки (suggested verification steps)
-------------------------------------------
1. Перед изменением: сделать резервную копию `backend/public/uploads` (если там есть важные файлы):

```powershell
Copy-Item -Path "C:\xampp\htdocs\healthcare-cms-backend\public\uploads" -Destination "C:\backup\uploads-$(Get-Date -Format yyyyMMdd-HHmmss)" -Recurse -Force
```

2. Запустить dry-run (пример выше) и просмотреть `sync-to-xampp.log`.
3. Если dry-run выглядит корректно, запустить реальный прогон.
4. Открыть публичную страницу, посмотреть исходник и убедиться, что изображения отдаются (или проверить `SERVE=`-комментарий — если `pre-rendered`, возможно, нужно очистить `rendered_html` для страницы или переопубликовать её).
5. Запустить `php backend/scripts/cleanup-missing-media.php --dry-run` для диагностики расхождений.

Rollback / откат
----------------
- При проблемах: восстановите `backend/public/uploads` из резервной копии, если вы её сделали. Скрипт не удаляет файлы `uploads`, так что прямой откат обычно не потребуется.

Дополнительные рекомендации (опционально)
----------------------------------------
1. Добавить простое логирование с ротацией (например, сохранять логи только за N дней). Это уменьшит рост файла `sync-to-xampp.log`.
2. Добавить запись в `docs/README.md` или `docs/DEPLOY.md`, описывающую правило: "uploads — user content, не синхронизируется; при переносе сервера — переносите uploads отдельно".
3. Настроить более надёжный резервный процесс для `uploads` (ежедневный `robocopy` в бэкап-папку или простая копия) вне процесса синхронизации кода.
4. (Опционально) Добавить в `sync-to-xampp.ps1` флаг `-BackupUploads` чтобы перед синхроном делать автоматический backup текущей папки uploads.

Качество изменений и проверки
----------------------------
- Изменения простые и ограничены скриптом деплоя — не касаются бизнес-логики приложения.
- Не требовалось подключать новые библиотеки (соответствует ограничениям проекта).
- Логика соответствует рекомендациям из `copilot-instructions.md` и `Project_functionality.md`.

Если нужно, могу дополнить:
- автоматическим резервированием `uploads` перед синхронизацией; или
- маленьким скриптом, который будет запускать `cleanup-missing-media.php` и формировать human-friendly отчёт (CSV/HTML) о расхождениях; или
- PR с изменением README/deploy docs и короткой заметкой в `docs/`.

Заключение
----------
Исправление предотвращает удаление пользовательских медиа при синхронизации и добавляет инструменты для диагностики (лог, dry-run, пост-проверка). Это безопасный, минимально-инвазивный и обратимый набор изменений, соответствующий политике проекта.
