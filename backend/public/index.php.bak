<?php

declare(strict_types=1);

/**
 * Entry Point - Expats Health Brazil CMS API
 */

// Автозагрузка Composer
require_once __DIR__ . '/../vendor/autoload.php';

// CORS Headers
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization');

// Preflight request
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Получение метода и URI
$method = $_SERVER['REQUEST_METHOD'];
$uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);

// Убираем /healthcare-backend/public/ из URI (или /backend/public/ для dev)
$uri = str_replace('/healthcare-cms-backend/public', '', $uri);
$uri = str_replace('/healthcare-backend/public', '', $uri);
$uri = str_replace('/backend/public', '', $uri);

// Простой роутер
try {
    // Auth
    if (preg_match('#^/api/auth/login$#', $uri) && $method === 'POST') {
        $controller = new \Presentation\Controller\AuthController();
        $controller->login();
    }
    elseif (preg_match('#^/api/auth/logout$#', $uri) && $method === 'POST') {
        $controller = new \Presentation\Controller\AuthController();
        $controller->logout();
    }
    elseif (preg_match('#^/api/auth/me$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controller\AuthController();
        $controller->me();
    }
    // Страницы
    elseif (preg_match('#^/api/pages$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controller\PageController();
        $controller->list();
    }
    elseif (preg_match('#^/api/pages$#', $uri) && $method === 'POST') {
        $controller = new \Presentation\Controller\PageController();
        $controller->create();
    }
    elseif (preg_match('#^/api/pages/([a-f0-9-]+)$#', $uri, $matches) && $method === 'GET') {
        $controller = new \Presentation\Controller\PageController();
        $controller->get($matches[1]);
    }
    elseif (preg_match('#^/api/pages/([a-f0-9-]+)$#', $uri, $matches) && $method === 'PUT') {
        $controller = new \Presentation\Controller\PageController();
        $controller->update($matches[1]);
    }
    elseif (preg_match('#^/api/pages/([a-f0-9-]+)/publish$#', $uri, $matches) && $method === 'PUT') {
        $controller = new \Presentation\Controller\PageController();
        $controller->publish($matches[1]);
    }
    elseif (preg_match('#^/api/pages/([a-f0-9-]+)$#', $uri, $matches) && $method === 'DELETE') {
        $controller = new \Presentation\Controller\PageController();
        $controller->delete($matches[1]);
    }
    // Menu (Public)
    elseif (preg_match('#^/api/menu/public$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controllers\MenuController();
        $controller->getPublicMenu();
    }
    // Menu (Old endpoints for Menu Editor - keep for backwards compatibility)
    elseif (preg_match('#^/api/menu$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controller\MenuController();
        $controller->index();
    }
    elseif (preg_match('#^/api/menu$#', $uri) && $method === 'POST') {
        $controller = new \Presentation\Controller\MenuController();
        $controller->create();
    }
    elseif (preg_match('#^/api/menu/reorder$#', $uri) && $method === 'PUT') {
        $controller = new \Presentation\Controller\MenuController();
        $controller->reorder();
    }
    elseif (preg_match('#^/api/menu/([a-f0-9-]+)$#', $uri, $matches) && $method === 'PUT') {
        $controller = new \Presentation\Controller\MenuController();
        $controller->update($matches[1]);
    }
    elseif (preg_match('#^/api/menu/([a-f0-9-]+)$#', $uri, $matches) && $method === 'DELETE') {
        $controller = new \Presentation\Controller\MenuController();
        $controller->delete($matches[1]);
    }
    // Settings
    elseif (preg_match('#^/api/settings$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controller\SettingsController();
        $controller->index();
    }
    elseif (preg_match('#^/api/settings$#', $uri) && $method === 'PUT') {
        $controller = new \Presentation\Controller\SettingsController();
        $controller->update();
    }
    // Users
    elseif (preg_match('#^/api/users$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controller\UserController();
        $controller->index();
    }
    elseif (preg_match('#^/api/users$#', $uri) && $method === 'POST') {
        $controller = new \Presentation\Controller\UserController();
        $controller->create();
    }
    elseif (preg_match('#^/api/users/([a-f0-9-]+)$#', $uri, $matches) && $method === 'PUT') {
        $controller = new \Presentation\Controller\UserController();
        $controller->update($matches[1]);
    }
    elseif (preg_match('#^/api/users/([a-f0-9-]+)$#', $uri, $matches) && $method === 'DELETE') {
        $controller = new \Presentation\Controller\UserController();
        $controller->delete($matches[1]);
    }
    // Media
    elseif (preg_match('#^/api/media$#', $uri) && $method === 'GET') {
        $controller = new \Presentation\Controller\MediaController();
        $controller->index();
    }
    elseif (preg_match('#^/api/media/upload$#', $uri) && $method === 'POST') {
        $controller = new \Presentation\Controller\MediaController();
        $controller->upload();
    }
    elseif (preg_match('#^/api/media/([a-f0-9-]+)$#', $uri, $matches) && $method === 'DELETE') {
        $controller = new \Presentation\Controller\MediaController();
        $controller->delete($matches[1]);
    }
    // Health check
    elseif ($uri === '/api/health' && $method === 'GET') {
        header('Content-Type: application/json');
        echo json_encode([
            'status' => 'ok',
            'service' => 'Expats Health Brazil CMS API',
            'version' => '1.0.0'
        ]);
        exit;
    }
    // 404
    else {
        http_response_code(404);
        header('Content-Type: application/json');
        echo json_encode(['error' => 'Endpoint not found']);
        exit;
    }
} catch (\Exception $e) {
    http_response_code(500);
    header('Content-Type: application/json');
    echo json_encode([
        'error' => 'Internal server error',
        'message' => $e->getMessage()
    ]);
    exit;
}
