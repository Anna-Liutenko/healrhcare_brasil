# Penetration Testing Script for XSS
# Run in PowerShell

# Base URL
$baseUrl = "http://localhost/healthcare-cms-backend"

# Test 1: Stored XSS via Page Creation
Write-Host "Test 1: Stored XSS via Page Creation"

# Login as editor
$loginBody = @{
    username = "editor_test"
    password = "TestPass123!"
} | ConvertTo-Json

$loginResponse = Invoke-WebRequest -Uri "$baseUrl/api/auth/login" -Method POST -Body $loginBody -ContentType "application/json"
$loginData = $loginResponse.Content | ConvertFrom-Json
$token = $loginData.token
$userId = $loginData.user.id

Write-Host "Login successful, token: $token, userId: $userId"

# Create page with XSS payload
$timestamp = Get-Date -Format "yyyyMMddHHmmss"
$pageBody = @{
    title = "Test XSS Page $timestamp"
    slug = "test-xss-$timestamp"
    status = "draft"
    type = "regular"
    created_by = $userId
    blocks = @(
        @{
            type = "text-block"
            position = 1
            data = @{
                title = "XSS Test"
                text = "<p>Safe text</p><script>alert('XSS')</script><p>More text</p>"
            }
        }
    )
} | ConvertTo-Json -Depth 10

$pageResponse = Invoke-WebRequest -Uri "$baseUrl/api/pages" -Method POST -Body $pageBody -ContentType "application/json" -Headers @{Authorization = "Bearer $token"}

$pageData = $pageResponse.Content | ConvertFrom-Json
$pageId = $pageData.pageId

Write-Host "Page creation response status: $($pageResponse.StatusCode)"
Write-Host "Page created with ID: $pageId"

# Publish the page
$publishResponse = Invoke-WebRequest -Uri "$baseUrl/api/pages/$pageId/publish" -Method PUT -Headers @{Authorization = "Bearer $token"}

Write-Host "Page publish response status: $($publishResponse.StatusCode)"

# Check if page renders without executing script (should be sanitized)
$publicResponse = Invoke-WebRequest -Uri "$baseUrl/test-xss-$timestamp" -Method GET
Write-Host "Public page response contains script tag: $($publicResponse.Content.Contains('<script>'))"

# Expected: false, sanitized

# Test 2: CSRF Attempt
Write-Host ""
Write-Host "Test 2: CSRF Attempt"

# Try to create page without token (CSRF simulation)
$pageBodyCsrf = @{
    title = "CSRF Test Page"
    slug = "csrf-test-$timestamp"
    status = "draft"
    type = "regular"
    created_by = $userId
    blocks = @(
        @{
            type = "text-block"
            position = 1
            data = @{
                title = "CSRF Test"
                text = "<p>CSRF attempt</p>"
            }
        }
    )
} | ConvertTo-Json -Depth 10

try {
    $csrfResponse = Invoke-WebRequest -Uri "$baseUrl/api/pages" -Method POST -Body $pageBodyCsrf -ContentType "application/json"
    Write-Host "CSRF attempt succeeded - VULNERABLE! Status: $($csrfResponse.StatusCode)"
} catch {
    Write-Host "CSRF attempt failed with status: $($_.Exception.Response.StatusCode) - Protected"
}

# Test 3: SQL Injection
Write-Host ""
Write-Host "Test 3: SQL Injection"

# Try SQLi in title
$sqliBody = @{
    title = "SQLi Test' OR '1'='1"
    slug = "sqli-test-$timestamp"
    status = "draft"
    type = "regular"
    created_by = $userId
    blocks = @(
        @{
            type = "text-block"
            position = 1
            data = @{
                title = "SQLi Test"
                text = "<p>SQL injection attempt</p>"
            }
        }
    )
} | ConvertTo-Json -Depth 10

try {
    $sqliResponse = Invoke-WebRequest -Uri "$baseUrl/api/pages" -Method POST -Body $sqliBody -ContentType "application/json" -Headers @{Authorization = "Bearer $token"}
    Write-Host "SQLi attempt in title succeeded - POTENTIALLY VULNERABLE! Status: $($sqliResponse.StatusCode)"
} catch {
    Write-Host "SQLi attempt failed with status: $($_.Exception.Response.StatusCode) - Protected"
}