import { blockDefinitions } from './blocks.js';
import { pageTemplates } from './templates.js';

const { createApp } = Vue;

createApp({
    data() {
        return {
            blocks: [],
            selectedBlockIndex: null,
            selectedBlock: null,
            showTemplatesModal: false,
            showGalleryModal: false,
            notification: null,
            activeTab: 'block',
            blockDefinitions: blockDefinitions,
            pageTemplates: pageTemplates,

            // Gallery
            galleryImages: [],
            selectedGalleryImage: null,
            currentImageField: null,
            currentArrayContext: null,
            uploadProgress: null,

            // Article Editor
            showArticleEditor: false,
            quillInstance: null,
            articleHtml: '',

            globalSettings: {
                header: {
                    logoText: 'Healthcare Hacks Brazil',
                    navItems: [
                        { text: '–ì–ª–∞–≤–Ω–∞—è', link: '#' },
                        { text: '–ì–∞–π–¥—ã', link: '#' },
                        { text: '–ë–ª–æ–≥', link: '#' },
                        { text: '–ë–æ—Ç', link: '#' }
                    ]
                },
                footer: {
                    logoText: 'Healthcare Hacks Brazil',
                    copyrightText: '¬© 2025 –ê–Ω–Ω–∞ –õ—é—Ç–µ–Ω–∫–æ (Anna Liutenko). –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.',
                    privacyLink: '#privacy',
                    privacyLinkText: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏'
                },
                cookieBanner: {
                    enabled: true,
                    message: '–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º cookie –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞. –ü—Ä–æ–¥–æ–ª–∂–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∞–π—Ç, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –Ω–∞—à–µ–π –ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.',
                    acceptText: '–ü—Ä–∏–Ω—è—Ç—å',
                    detailsText: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ'
                }
            }
        };
    },

    mounted() {
        this.loadFromLocalStorage();
    },

    updated() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å—Ç–∞—Ç–µ–π
        this.$nextTick(() => {
            if (this.showArticleEditor && !this.quillInstance) {
                this.initQuillEditor();
            }
        });
    },

    methods: {
        // ===== BLOCK MANAGEMENT =====

        addBlock(blockDef) {
            const newBlock = {
                type: blockDef.type,
                data: JSON.parse(JSON.stringify(blockDef.defaultData))
            };

            this.blocks.push(newBlock);
            this.selectedBlockIndex = this.blocks.length - 1;
            this.selectedBlock = this.blocks[this.selectedBlockIndex];
            this.activeTab = 'block';

            this.showNotification('–ë–ª–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        },

        selectBlock(index) {
            this.selectedBlockIndex = index;
            this.selectedBlock = this.blocks[index];
            this.activeTab = 'block';
        },

        moveBlockUp(index) {
            if (index === 0) return;
            const blocks = this.blocks;
            [blocks[index - 1], blocks[index]] = [blocks[index], blocks[index - 1]];
            this.selectedBlockIndex = index - 1;
        },

        moveBlockDown(index) {
            if (index === this.blocks.length - 1) return;
            const blocks = this.blocks;
            [blocks[index], blocks[index + 1]] = [blocks[index + 1], blocks[index]];
            this.selectedBlockIndex = index + 1;
        },

        duplicateBlock(index) {
            const blockCopy = JSON.parse(JSON.stringify(this.blocks[index]));
            this.blocks.splice(index + 1, 0, blockCopy);
            this.showNotification('–ë–ª–æ–∫ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω', 'success');
        },

        removeBlock(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) {
                this.blocks.splice(index, 1);
                if (this.selectedBlockIndex === index) {
                    this.selectedBlock = null;
                    this.selectedBlockIndex = null;
                }
                this.showNotification('–ë–ª–æ–∫ —É–¥–∞–ª—ë–Ω', 'success');
            }
        },

        applyTemplate(template) {
            if (confirm(`–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω "${template.name}"?\n\n–¢–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) {
                this.blocks = JSON.parse(JSON.stringify(template.blocks));
                this.showTemplatesModal = false;
                this.selectedBlock = null;
                this.selectedBlockIndex = null;
                this.showNotification(`‚ú® –®–∞–±–ª–æ–Ω "${template.name}" –ø—Ä–∏–º–µ–Ω—ë–Ω!`, 'success');
            }
        },

        // ===== ARTICLE EDITOR =====

        async openArticleEditor() {
            this.showArticleEditor = true;

            // –ú–µ–Ω—è–µ–º URL
            window.history.pushState({}, '', window.location.pathname + '#article-editor');

            this.showNotification('–û—Ç–∫—Ä—ã–≤–∞—é —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç–µ–π...', 'success');
        },

        alignText(alignment) {
            if (!this.quillInstance) return;

            const quill = this.quillInstance;
            const range = quill.getSelection();

            if (range) {
                quill.format('align', alignment);
                this.showNotification(`–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: ${alignment}`, 'success');
            }
        },

        closeArticleEditor() {
            if (confirm('–ó–∞–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä? –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                this.quillInstance = null;
                this.showArticleEditor = false;

                // –ú–µ–Ω—è–µ–º URL –æ–±—Ä–∞—Ç–Ω–æ
                window.history.pushState({}, '', window.location.pathname);
            }
        },

        async saveArticleAndClose() {
            if (this.quillInstance) {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º HTML –∏–∑ Quill
                    this.articleHtml = this.quillInstance.root.innerHTML;

                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTML –≤ –Ω–∞—à–∏ –±–ª–æ–∫–∏
                    this.convertHtmlToBlocks(this.articleHtml);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    this.saveToLocalStorage();

                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    this.quillInstance = null;
                    this.showArticleEditor = false;

                    // –ú–µ–Ω—è–µ–º URL –æ–±—Ä–∞—Ç–Ω–æ
                    window.history.pushState({}, '', window.location.pathname);

                    this.showNotification('‚úÖ –°—Ç–∞—Ç—å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                } catch (e) {
                    console.error('Saving error:', e);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                }
            }
        },

        async initQuillEditor() {
            if (!window.Quill) {
                console.error('Quill not loaded');
                return;
            }

            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –º–æ–¥—É–ª—å ImageResize –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (window.ImageResize) {
                Quill.register('modules/imageResize', window.ImageResize.default);
            }

            // –ö–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–ª–∞—Å—Å)
            class UploadAdapter {
                constructor(loader) {
                    this.loader = loader;
                }

                upload() {
                    return this.loader.file.then(file => new Promise((resolve, reject) => {
                        const formData = new FormData();
                        formData.append('file', file);

                        fetch('upload.php', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.url) {
                                resolve({ default: data.url });
                            } else {
                                reject(data.error || 'Upload failed');
                            }
                        })
                        .catch(error => {
                            reject('Upload error: ' + error);
                        });
                    }));
                }

                abort() {}
            }

            function UploadAdapterPlugin(editor) {
                editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                    return new UploadAdapter(loader);
                };
            }

            try {
                const editor = await ClassicEditor.create(document.querySelector('#ckeditor'), {
                    language: 'ru',
                    extraPlugins: [UploadAdapterPlugin],
                    toolbar: {
                        items: [
                            'heading', '|',
                            'bold', 'italic', 'strikethrough', '|',
                            'link', '|',
                            'bulletedList', 'numberedList', '|',
                            'blockQuote', '|',
                            'imageUpload', '|',
                            'undo', 'redo'
                        ]
                    },
                    heading: {
                        options: [
                            { model: 'paragraph', title: '–ü–∞—Ä–∞–≥—Ä–∞—Ñ', class: 'ck-heading_paragraph' },
                            { model: 'heading2', view: 'h2', title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3', class: 'ck-heading_heading3' },
                            { model: 'heading4', view: 'h4', title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 4', class: 'ck-heading_heading4' }
                        ]
                    },
                    link: {
                        addTargetToExternalLinks: true,
                        defaultProtocol: 'https://'
                    }
                });

                this.ckEditorInstance = editor;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                if (this.articleHtml) {
                    editor.setData(this.articleHtml);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
                this.$nextTick(() => {
                    this.setupImageControls();
                });
            } catch (error) {
                console.error('CKEditor init error:', error);
                this.showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞', 'error');
            }
        },

        setupImageControls() {
            const editorElement = document.querySelector('.ck-editor__editable');
            if (!editorElement) return;

            let imageToolbar = null;
            let currentImage = null;

            // –°–æ–∑–¥–∞—ë–º toolbar –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const createImageToolbar = () => {
                if (imageToolbar) return imageToolbar;

                imageToolbar = document.createElement('div');
                imageToolbar.className = 'image-toolbar';
                imageToolbar.style.display = 'none';
                imageToolbar.innerHTML = `
                    <button data-action="align-left" title="–í–ª–µ–≤–æ">‚Üê –í–ª–µ–≤–æ</button>
                    <button data-action="align-center" title="–¶–µ–Ω—Ç—Ä">‚Üî –¶–µ–Ω—Ç—Ä</button>
                    <button data-action="align-right" title="–í–ø—Ä–∞–≤–æ">–í–ø—Ä–∞–≤–æ ‚Üí</button>
                    <span style="border-left: 2px solid #ccc; margin: 0 0.25rem;"></span>
                    <button data-action="size-small" title="30%">30%</button>
                    <button data-action="size-medium" title="45%">45%</button>
                    <button data-action="size-large" title="70%">70%</button>
                    <button data-action="size-full" title="100%">100%</button>
                `;
                document.body.appendChild(imageToolbar);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                imageToolbar.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button || !currentImage) return;

                    const action = button.dataset.action;

                    // –£–±–∏—Ä–∞–µ–º float –∏ margin –¥–ª—è —Å–±—Ä–æ—Å–∞
                    currentImage.style.float = '';
                    currentImage.style.marginLeft = '';
                    currentImage.style.marginRight = '';
                    currentImage.style.marginBottom = '';
                    currentImage.style.display = '';

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
                    if (action === 'align-left') {
                        currentImage.style.float = 'left';
                        currentImage.style.marginRight = '2rem';
                        currentImage.style.marginBottom = '1.5rem';
                    } else if (action === 'align-center') {
                        currentImage.style.display = 'block';
                        currentImage.style.marginLeft = 'auto';
                        currentImage.style.marginRight = 'auto';
                        currentImage.style.marginBottom = '1.5rem';
                    } else if (action === 'align-right') {
                        currentImage.style.float = 'right';
                        currentImage.style.marginLeft = '2rem';
                        currentImage.style.marginBottom = '1.5rem';
                    }

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä
                    if (action === 'size-small') {
                        currentImage.style.maxWidth = '30%';
                    } else if (action === 'size-medium') {
                        currentImage.style.maxWidth = '45%';
                    } else if (action === 'size-large') {
                        currentImage.style.maxWidth = '70%';
                    } else if (action === 'size-full') {
                        currentImage.style.maxWidth = '100%';
                    }

                    updateToolbarButtons();
                });

                return imageToolbar;
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ toolbar
            const updateToolbarButtons = () => {
                if (!imageToolbar || !currentImage) return;

                const buttons = imageToolbar.querySelectorAll('button');
                buttons.forEach(btn => btn.classList.remove('active'));

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ inline —Å—Ç–∏–ª—è–º
                const float = currentImage.style.float;
                const display = currentImage.style.display;
                const marginLeft = currentImage.style.marginLeft;
                const marginRight = currentImage.style.marginRight;

                if (float === 'left') {
                    imageToolbar.querySelector('[data-action="align-left"]')?.classList.add('active');
                } else if (float === 'right') {
                    imageToolbar.querySelector('[data-action="align-right"]')?.classList.add('active');
                } else if (display === 'block' && marginLeft === 'auto' && marginRight === 'auto') {
                    imageToolbar.querySelector('[data-action="align-center"]')?.classList.add('active');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ inline —Å—Ç–∏–ª—è–º
                const maxWidth = currentImage.style.maxWidth;
                if (maxWidth === '30%') {
                    imageToolbar.querySelector('[data-action="size-small"]')?.classList.add('active');
                } else if (maxWidth === '45%') {
                    imageToolbar.querySelector('[data-action="size-medium"]')?.classList.add('active');
                } else if (maxWidth === '70%') {
                    imageToolbar.querySelector('[data-action="size-large"]')?.classList.add('active');
                } else if (maxWidth === '100%') {
                    imageToolbar.querySelector('[data-action="size-full"]')?.classList.add('active');
                }
            };

            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º toolbar —Ä—è–¥–æ–º —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const positionToolbar = (img) => {
                if (!imageToolbar) return;

                const rect = img.getBoundingClientRect();
                imageToolbar.style.display = 'flex';
                imageToolbar.style.left = rect.left + 'px';
                imageToolbar.style.top = (rect.top - 50) + 'px';
            };

            // –°–ª—É—à–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            editorElement.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') {
                    currentImage = e.target;
                    createImageToolbar();
                    positionToolbar(currentImage);
                    updateToolbarButtons();
                    e.preventDefault();
                    e.stopPropagation();
                }
            });

            // –¢–∞–∫–∂–µ —Å–ª—É—à–∞–µ–º –∫–ª–∏–∫–∏ —á–µ—Ä–µ–∑ MutationObserver –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const observer = new MutationObserver(() => {
                const images = editorElement.querySelectorAll('img');
                images.forEach(img => {
                    if (!img.dataset.listenerAdded) {
                        img.dataset.listenerAdded = 'true';
                        img.addEventListener('click', (e) => {
                            currentImage = img;
                            createImageToolbar();
                            positionToolbar(currentImage);
                            updateToolbarButtons();
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    }
                });
            });

            observer.observe(editorElement, {
                childList: true,
                subtree: true
            });

            // –°–∫—Ä—ã–≤–∞–µ–º toolbar –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            document.addEventListener('click', (e) => {
                if (imageToolbar &&
                    !e.target.closest('.image-toolbar') &&
                    e.target.tagName !== 'IMG') {
                    imageToolbar.style.display = 'none';
                    currentImage = null;
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
            window.addEventListener('scroll', () => {
                if (imageToolbar && currentImage && imageToolbar.style.display !== 'none') {
                    positionToolbar(currentImage);
                }
            });
        },

        convertHtmlToBlocks(html) {
            // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è - —Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π text-block —Å HTML
            this.blocks = [
                {
                    type: 'page-header',
                    data: {
                        title: '–°—Ç–∞—Ç—å—è',
                        subtitle: '–°–æ–∑–¥–∞–Ω–æ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Å—Ç–∞—Ç–µ–π'
                    }
                },
                {
                    type: 'text-block',
                    data: {
                        title: '',
                        content: html,
                        alignment: 'left',
                        containerStyle: 'article'
                    }
                }
            ];
        },

        // ===== HELPERS =====

        getBlockIcon(type) {
            const def = this.blockDefinitions.find(b => b.type === type);
            return def ? def.icon : 'üì¶';
        },

        getBlockName(type) {
            const def = this.blockDefinitions.find(b => b.type === type);
            return def ? def.name : type;
        },

        escape(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        nl2br(text) {
            if (!text) return '';
            return text.replace(/\n/g, '<br>');
        },

        formatLabel(key) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç camelCase –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            const labels = {
                'title': '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
                'subtitle': '–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫',
                'text': '–¢–µ–∫—Å—Ç',
                'content': '–ö–æ–Ω—Ç–µ–Ω—Ç',
                'backgroundImage': '–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                'buttonText': '–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏',
                'buttonLink': '–°—Å—ã–ª–∫–∞ –∫–Ω–æ–ø–∫–∏',
                'image': '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL)',
                'url': 'URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
                'alt': 'Alt —Ç–µ–∫—Å—Ç',
                'caption': '–ü–æ–¥–ø–∏—Å—å',
                'alignment': '–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ',
                'width': '–®–∏—Ä–∏–Ω–∞',
                'height': '–í—ã—Å–æ—Ç–∞',
                'borderRadius': '–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤',
                'columns': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫',
                'cards': '–ö–∞—Ä—Ç–æ—á–∫–∏',
                'items': '–≠–ª–µ–º–µ–Ω—Ç—ã',
                'paragraphs': '–ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã',
                'messages': '–°–æ–æ–±—â–µ–Ω–∏—è',
                'buttons': '–ö–Ω–æ–ø–∫–∏',
                'headerTitle': '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞',
                'icon': 'SVG –∏–∫–æ–Ω–∫–∞',
                'link': '–°—Å—ã–ª–∫–∞',
                'question': '–í–æ–ø—Ä–æ—Å',
                'answer': '–û—Ç–≤–µ—Ç',
                'type': '–¢–∏–ø',
                'containerStyle': '–°—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞',
                'style': '–°—Ç–∏–ª—å'
            };
            return labels[key] || key;
        },

        addArrayItem(key) {
            if (!this.selectedBlock) return;

            const array = this.selectedBlock.data[key];
            if (!Array.isArray(array)) return;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
            if (array.length > 0) {
                const template = array[0];
                const newItem = {};
                for (const k in template) {
                    if (typeof template[k] === 'string') {
                        newItem[k] = '';
                    } else if (typeof template[k] === 'number') {
                        newItem[k] = 0;
                    } else {
                        newItem[k] = template[k];
                    }
                }
                array.push(newItem);
            } else {
                // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
                if (key === 'cards' && this.selectedBlock.type === 'service-cards') {
                    array.push({ icon: '', title: '–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞', text: '–û–ø–∏—Å–∞–Ω–∏–µ' });
                } else if (key === 'cards' && this.selectedBlock.type === 'article-cards') {
                    array.push({ image: '', title: '–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è', text: '–û–ø–∏—Å–∞–Ω–∏–µ', link: '#' });
                } else if (key === 'paragraphs') {
                    array.push('–ù–æ–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ');
                } else if (key === 'messages') {
                    array.push({ type: 'bot', text: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ' });
                } else if (key === 'buttons') {
                    array.push({ text: '–ö–Ω–æ–ø–∫–∞' });
                } else if (key === 'items') {
                    array.push({ question: '–í–æ–ø—Ä–æ—Å?', answer: '–û—Ç–≤–µ—Ç' });
                } else {
                    array.push({ text: '–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç' });
                }
            }

            this.showNotification('–≠–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        },

        removeArrayItem(key, index) {
            if (!this.selectedBlock) return;
            const array = this.selectedBlock.data[key];
            if (!Array.isArray(array)) return;

            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
                array.splice(index, 1);
                this.showNotification('–≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª—ë–Ω', 'success');
            }
        },

        // ===== RENDER METHODS =====

        renderBlock(block) {
            const methods = {
                'main-screen': this.renderMainScreen,
                'page-header': this.renderPageHeader,
                'service-cards': this.renderServiceCards,
                'article-cards': this.renderArticleCards,
                'about-section': this.renderAboutSection,
                'text-block': this.renderTextBlock,
                'image-block': this.renderImageBlock,
                'blockquote': this.renderBlockquote,
                'button': this.renderButton,
                'section-title': this.renderSectionTitle,
                'section-divider': this.renderSectionDivider,
                'chat-bot': this.renderChatBot,
                'spacer': this.renderSpacer
            };

            return methods[block.type] ? methods[block.type](block.data) : '<div>Unknown block type</div>';
        },

        renderMainScreen(data) {
            const bgImage = data.backgroundImage || 'https://images.unsplash.com/photo-1506929562872-bb421503ef21?q=80&w=2070&auto=format&fit=crop';
            const title = data.title || '';
            const text = data.text || '';
            const buttonText = data.buttonText || '–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ';
            const buttonLink = data.buttonLink || '#';

            return `
                <section class="hero" style="background-image: linear-gradient(rgba(3, 42, 73, 0.6), rgba(3, 42, 73, 0.6)), url('${this.escape(bgImage)}');">
                    <div class="container">
                        <h1>${title}</h1>
                        <p>${this.escape(text)}</p>
                        <a href="${this.escape(buttonLink)}" class="btn btn-primary">${this.escape(buttonText)}</a>
                    </div>
                </section>
            `;
        },

        renderPageHeader(data) {
            const title = data.title || '–ó–∞–≥–æ–ª–æ–≤–æ–∫';
            const subtitle = data.subtitle || '';

            return `
                <section class="page-header unified-background">
                    <div class="container">
                        <h2>${this.escape(title)}</h2>
                        ${subtitle ? `<p class="sub-heading">${this.escape(subtitle)}</p>` : ''}
                    </div>
                </section>
            `;
        },

        renderServiceCards(data) {
            const title = data.title || '';
            const subtitle = data.subtitle || '';
            const cards = data.cards || [];
            const columns = data.columns || 2;

            const cardsHtml = cards.map(card => `
                <div class="service-card">
                    <div class="icon">${card.icon || ''}</div>
                    <h3>${this.escape(card.title || '')}</h3>
                    <p>${this.escape(card.text || '')}</p>
                </div>
            `).join('');

            return `
                <section>
                    <div class="container">
                        ${title ? `<h2 class="text-center">${this.escape(title)}</h2>` : ''}
                        ${subtitle ? `<p class="sub-heading text-center">${this.escape(subtitle)}</p>` : ''}
                        <div class="services-grid" style="grid-template-columns: repeat(${columns}, 1fr);">
                            ${cardsHtml}
                        </div>
                    </div>
                </section>
            `;
        },

        renderArticleCards(data) {
            const title = data.title || '';
            const cards = data.cards || [];
            const columns = data.columns || 3;

            const cardsHtml = cards.map(card => `
                <div class="article-card">
                    <img src="${this.escape(card.image || '')}" alt="${this.escape(card.title || '')}">
                    <div class="article-card-content">
                        <h3>${this.escape(card.title || '')}</h3>
                        <p>${this.escape(card.text || '')}</p>
                        <a href="${this.escape(card.link || '#')}">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ &rarr;</a>
                    </div>
                </div>
            `).join('');

            return `
                <section style="padding-top: ${title ? '6rem' : '0'};">
                    <div class="container">
                        ${title ? `<h2>${this.escape(title)}</h2>` : ''}
                        <div class="articles-grid" style="grid-template-columns: repeat(${columns}, 1fr);">
                            ${cardsHtml}
                        </div>
                    </div>
                </section>
            `;
        },

        renderAboutSection(data) {
            const image = data.image || 'https://placehold.co/600x720/E9EAF2/032A49?text=Photo';
            const title = data.title || '–û —Å–µ–±–µ';
            const paragraphs = data.paragraphs || [];

            const paragraphsHtml = paragraphs.map(p =>
                `<p>${this.escape(typeof p === 'string' ? p : p.text || '')}</p>`
            ).join('');

            return `
                <section class="about-section">
                    <div class="container">
                        <div class="about-me">
                            <img src="${this.escape(image)}" alt="${this.escape(title)}" class="about-me-photo">
                            <div>
                                <h2>${this.escape(title)}</h2>
                                ${paragraphsHtml}
                            </div>
                        </div>
                    </div>
                </section>
            `;
        },

        renderTextBlock(data) {
            const title = data.title || '';
            const content = data.content || '';
            const alignment = data.alignment || 'left';
            const containerStyle = data.containerStyle || 'normal';

            const containerClass = containerStyle === 'article' ? 'article-container' : 'container';
            const alignClass = alignment === 'center' ? 'text-center' : alignment === 'right' ? 'text-right' : 'text-left';

            return `
                <section class="article-block">
                    <div class="${containerClass}">
                        <div class="article-content ${alignClass}">
                            ${title ? `<h2>${this.escape(title)}</h2>` : ''}
                            <p>${content}</p>
                        </div>
                    </div>
                </section>
            `;
        },

        renderImageBlock(data) {
            const url = data.url || 'https://via.placeholder.com/800x400';
            const alt = data.alt || '';
            const caption = data.caption || '';
            const alignment = data.alignment || 'center';
            const width = data.width || '100%';
            const borderRadius = data.borderRadius || '12px';

            let imageClass = '';
            let imageStyle = `border-radius: ${borderRadius};`;

            if (alignment === 'float-left') {
                imageClass = 'article-image-left';
                imageStyle = `width: ${width}; border-radius: ${borderRadius};`;
            } else if (alignment === 'float-right') {
                imageClass = 'article-image-right';
                imageStyle = `width: ${width}; border-radius: ${borderRadius};`;
            } else {
                imageStyle += ` width: 100%; max-width: 900px; display: block; margin: 0 auto;`;
            }

            return `
                <section class="article-block">
                    <div class="container">
                        <figure style="max-width: 900px; margin: 0 auto;">
                            <img src="${this.escape(url)}" alt="${this.escape(alt)}" class="${imageClass}" style="${imageStyle}">
                            ${caption ? `<figcaption style="text-align: center; color: var(--text-secondary); margin-top: 1rem; font-size: 0.95rem;">${this.escape(caption)}</figcaption>` : ''}
                        </figure>
                    </div>
                </section>
            `;
        },

        renderBlockquote(data) {
            const text = data.text || '';

            return `
                <section class="article-block">
                    <div class="article-container">
                        <div class="article-content">
                            <blockquote>${this.escape(text)}</blockquote>
                        </div>
                    </div>
                </section>
            `;
        },

        renderButton(data) {
            const text = data.text || '–ö–Ω–æ–ø–∫–∞';
            const link = data.link || '#';
            const alignment = data.alignment || 'center';
            const style = data.style || 'primary';

            const alignClass = alignment === 'left' ? 'text-left' : alignment === 'right' ? 'text-right' : 'text-center';
            const btnClass = style === 'primary' ? 'btn-primary' : 'btn-primary';

            return `
                <section style="padding-top: 0;">
                    <div class="container ${alignClass}" style="margin-top: 3rem; display: flex; justify-content: ${alignment === 'left' ? 'flex-start' : alignment === 'right' ? 'flex-end' : 'center'};">
                        <a href="${this.escape(link)}" class="btn ${btnClass}" style="display: inline-block; width: auto;">${this.escape(text)}</a>
                    </div>
                </section>
            `;
        },

        renderSectionTitle(data) {
            const text = data.text || '–ó–∞–≥–æ–ª–æ–≤–æ–∫';
            const alignment = data.alignment || 'left';

            const style = alignment === 'center' ? 'text-align: center;' : alignment === 'right' ? 'text-align: right;' : 'text-align: left;';

            return `
                <section class="article-block" style="padding-top: 2rem;">
                    <div class="container">
                        <h3 style="font-family: var(--font-heading); font-size: 1.8rem; margin-bottom: 1rem; color: var(--text-dark); ${style}">${this.escape(text)}</h3>
                    </div>
                </section>
            `;
        },

        renderSectionDivider(data) {
            return `
                <section style="padding: 3rem 0;">
                    <div class="container">
                        <hr class="section-divider">
                    </div>
                </section>
            `;
        },

        renderChatBot(data) {
            const headerTitle = data.headerTitle || '–ß–∞—Ç-–±–æ—Ç';
            const messages = data.messages || [];
            const buttons = data.buttons || [];

            const messagesHtml = messages.map(msg => `
                <div class="message ${msg.type}">
                    <span class="bubble">${this.escape(msg.text)}</span>
                </div>
            `).join('');

            const buttonsHtml = buttons.map(btn => `
                <button>${this.escape(btn.text)}</button>
            `).join('');

            return `
                <section style="padding-top: 0;">
                    <div class="container">
                        <div class="chat-container">
                            <div class="chat-header">
                                <h3>${this.escape(headerTitle)}</h3>
                            </div>
                            <div class="chat-messages">
                                ${messagesHtml}
                            </div>
                            <div class="chat-input">
                                <div class="chat-options">
                                    ${buttonsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
        },

        renderSpacer(data) {
            const height = data.height || 60;
            return `<div style="height: ${height}px;"></div>`;
        },


        // ===== STORAGE =====

        saveToLocalStorage() {
            const data = {
                blocks: this.blocks,
                globalSettings: this.globalSettings
            };
            localStorage.setItem('visualEditorData', JSON.stringify(data));
            this.showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage', 'success');
        },

        loadFromLocalStorage() {
            const saved = localStorage.getItem('visualEditorData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    this.blocks = data.blocks || [];
                    if (data.globalSettings) {
                        this.globalSettings = data.globalSettings;
                    }
                    this.showNotification('üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage', 'success');
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
            }
        },

        exportHTML() {
            let html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Hacks Brazil</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="main-header">
        <div class="container">
            <a href="#" class="logo">${this.escape(this.globalSettings.header.logoText)}</a>
            <nav class="main-nav">
                <ul>`;

            for (const item of this.globalSettings.header.navItems) {
                html += `
                    <li><a href="${this.escape(item.link)}">${this.escape(item.text)}</a></li>`;
            }

            html += `
                </ul>
            </nav>
        </div>
    </header>

    <main>`;

            for (const block of this.blocks) {
                html += this.renderBlock(block);
            }

            html += `
    </main>

    <footer class="main-footer">
        <div class="container">
            <a href="#" class="logo">${this.escape(this.globalSettings.footer.logoText)}</a>
            <p>${this.escape(this.globalSettings.footer.copyrightText)}</p>`;

            if (this.globalSettings.footer.privacyLink) {
                html += `
            <p><a href="${this.escape(this.globalSettings.footer.privacyLink)}">${this.escape(this.globalSettings.footer.privacyLinkText)}</a></p>`;
            }

            html += `
        </div>
    </footer>`;

            if (this.globalSettings.cookieBanner.enabled) {
                html += `

    <div class="cookie-banner" id="cookieBanner">
        <div class="cookie-banner-content">
            <div class="cookie-banner-text">
                <p>${this.escape(this.globalSettings.cookieBanner.message)}</p>
            </div>
            <div class="cookie-banner-actions">
                <button class="cookie-btn cookie-btn-accept" onclick="acceptCookies()">${this.escape(this.globalSettings.cookieBanner.acceptText)}</button>
                <button class="cookie-btn cookie-btn-details" onclick="window.location.href='#privacy'">${this.escape(this.globalSettings.cookieBanner.detailsText)}</button>
            </div>
        </div>
    </div>

    <script>
        function acceptCookies() {
            localStorage.setItem('cookiesAccepted', 'true');
            document.getElementById('cookieBanner').style.display = 'none';
        }

        window.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('cookiesAccepted') === 'true') {
                document.getElementById('cookieBanner').style.display = 'none';
            }
        });
    </script>`;
            }

            html += `
</body>
</html>`;

            // Download HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'healthcare-brazil.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.showNotification('üì• HTML —Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
        },

        // ===== GALLERY =====

        async openGallery(fieldKey) {
            this.currentImageField = fieldKey;
            this.currentArrayContext = null;
            this.selectedGalleryImage = null;
            this.showGalleryModal = true;
            await this.loadGalleryImages();
        },

        async openGalleryForArrayItem(arrayKey, itemIndex, fieldKey) {
            this.currentImageField = fieldKey;
            this.currentArrayContext = { arrayKey, itemIndex };
            this.selectedGalleryImage = null;
            this.showGalleryModal = true;
            await this.loadGalleryImages();
        },

        async loadGalleryImages() {
            try {
                const response = await fetch('upload.php');
                const data = await response.json();
                if (data.success) {
                    this.galleryImages = data.files || [];
                }
            } catch (e) {
                console.error('Error loading gallery:', e);
                this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏', 'error');
            }
        },

        selectImageFromGallery(url) {
            this.selectedGalleryImage = url;
        },

        confirmImageSelection() {
            if (!this.selectedGalleryImage) return;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –≤ –º–∞—Å—Å–∏–≤–µ
            if (this.currentArrayContext && this.selectedBlock) {
                const { arrayKey, itemIndex } = this.currentArrayContext;
                const array = this.selectedBlock.data[arrayKey];
                if (array && array[itemIndex]) {
                    array[itemIndex][this.currentImageField] = this.selectedGalleryImage;
                }
            }
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–ª—è
            else if (this.selectedBlock) {
                this.selectedBlock.data[this.currentImageField] = this.selectedGalleryImage;
            }

            this.showGalleryModal = false;
            this.selectedGalleryImage = null;
            this.currentImageField = null;
            this.currentArrayContext = null;
            this.showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ', 'success');
        },

        async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                this.showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)', 'error');
                return;
            }

            this.uploadProgress = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('upload.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    this.uploadProgress = null;
                    this.showNotification('‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                    await this.loadGalleryImages();
                    // Auto-select newly uploaded image
                    this.selectedGalleryImage = data.file.url;
                } else {
                    this.uploadProgress = null;
                    this.showNotification('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                this.uploadProgress = null;
                console.error('Upload error:', e);
                this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'error');
            }

            // Reset file input
            event.target.value = '';
        },

        async deleteImage(filename) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${filename}"?`)) return;

            try {
                const response = await fetch('upload.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename })
                });

                const data = await response.json();

                if (data.success) {
                    this.showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                    await this.loadGalleryImages();
                    if (this.selectedGalleryImage && this.selectedGalleryImage.includes(filename)) {
                        this.selectedGalleryImage = null;
                    }
                } else {
                    this.showNotification('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                console.error('Delete error:', e);
                this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
            }
        },

        // ===== NOTIFICATIONS =====

        showNotification(message, type = 'success') {
            this.notification = { message, type };
            setTimeout(() => {
                this.notification = null;
            }, 3000);
        }
    }
}).mount('#app');
