<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Visual Editor - Healthcare Brazil</title>

    <link rel="stylesheet" href="styles.css">

    <!-- Quill.js -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Quill ImageResize Module -->
    <script src="https://unpkg.com/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        console.info('Healthcare CMS visual editor build 2025-10-05-1 loaded');
    </script>

    <link rel="stylesheet" href="editor-preview.css">
    <link rel="stylesheet" href="editor-ui.css">
</head>
<body>
    <div id="app" v-cloak>
        <div class="editor-wrapper">
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <div class="toolbar-title">
                    Healthcare Brazil - Visual Editor
                    <span v-if="currentUser" style="font-size: 0.85rem; margin-left: 1rem; opacity: 0.7;">
                        üë§ {{ currentUser.username }}
                    </span>
                </div>
                <div class="toolbar-actions">
                    <button v-if="currentUser" @click="openArticleEditor" class="toolbar-btn save">
                        ‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å—Ç–∞—Ç—å—é
                    </button>
                    <button v-if="currentUser" @click="openMediaLibrary" class="toolbar-btn save" title="–û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–∏–∞—Ç–µ–∫—É">
                        üñºÔ∏è –ú–µ–¥–∏–∞—Ç–µ–∫–∞
                    </button>
                    <button v-if="currentUser" @click="savePage" class="toolbar-btn save">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button v-if="currentUser && currentPageId && pageData.status === 'draft'" @click="publishPage" class="toolbar-btn export">
                        üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                    </button>
                    <button v-if="currentUser" @click="exportHTML" class="toolbar-btn save">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç HTML
                    </button>
                    <button v-if="currentUser" @click="logout" class="toolbar-btn save" style="margin-left: 1rem;">
                        üö™ –í—ã—Ö–æ–¥
                    </button>
                </div>
            </div>

            <div class="editor-container">
                <!-- Left Panel - Blocks Library -->
                <div class="blocks-library">
                    <h2 class="library-title">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±–ª–æ–∫–æ–≤</h2>

                    <div class="library-blocks">
                        <div
                            v-for="block in blockDefinitions"
                            :key="block.type"
                            @click="addBlock(block)"
                            draggable="true"
                            @dragstart="onLibraryBlockDragStart($event, block)"
                            @dragend="onLibraryBlockDragEnd"
                            class="library-block"
                        >
                            <div class="library-block-header">
                                <span class="library-block-icon" v-html="block.icon"></span>
                                <span class="library-block-name">{{ block.name }}</span>
                                <span v-if="block.type !== 'spacer'"
                                      class="library-block-preview-icon"
                                      @click.stop="showBlockPreview(block)"
                                      title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±–ª–æ–∫–∞">
                                    üëÅÔ∏è
                                </span>
                            </div>
                            <div class="library-block-desc">{{ block.description }}</div>
                        </div>
                    </div>

                    <div class="library-divider"></div>

                    <h3 class="library-title">–ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã</h3>
                    <button @click="showTemplatesModal = true" class="library-templates-btn">
                        üìÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω
                    </button>
                </div>

                <!-- Center - Preview Area -->
                <div class="preview-area"
                     @drop="onPreviewDrop"
                     @dragover="onPreviewDragOver"
                     @dragleave="onPreviewDragLeave">
                    <div class="preview-wrapper">
                        <!-- Header -->
                        <header class="main-header">
                            <div class="container">
                                <a href="#" class="logo">{{ globalSettings.header.logoText }}</a>
                                <nav class="main-nav">
                                    <ul>
                                        <li v-for="(item, index) in globalSettings.header.navItems" :key="index">
                                            <a :href="item.link">{{ item.text }}</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </header>

                        <!-- Blocks -->
                        <main>
                            <div v-if="blocks.length === 0" class="empty-state">
                                <div class="empty-icon">üé®</div>
                                <h3 style="font-family: var(--font-heading); color: var(--text-dark); margin-bottom: 0.5rem;">
                                    –ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å
                                </h3>
                                <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å–ª–µ–≤–∞</p>
                            </div>

                            <div v-else>
                                <div
                                    v-for="(block, index) in blocks"
                                    :key="index"
                                    @click="selectBlock(index)"
                                    draggable="true"
                                    @dragstart="onBlockDragStart($event, index)"
                                    @dragend="onBlockDragEnd"
                                    @dragover="onBlockDragOver($event, index)"
                                    @drop="onBlockDrop($event, index)"
                                    class="block-item"
                                    :class="{ 'selected': selectedBlockIndex === index, 'dragging': draggedBlockIndex === index }"
                                >
                                    <!-- Custom Block Name Label -->
                                    <div v-if="block.customName" class="block-custom-name">
                                        {{ block.customName }}
                                    </div>

                                    <!-- Block Controls -->
                                    <div class="block-controls">
                                        <button v-if="index > 0" @click.stop="moveBlockUp(index)" class="block-control-btn" title="–í–≤–µ—Ä—Ö">‚ñ≤</button>
                                        <button v-if="index < blocks.length - 1" @click.stop="moveBlockDown(index)" class="block-control-btn" title="–í–Ω–∏–∑">‚ñº</button>
                                        <button @click.stop="duplicateBlock(index)" class="block-control-btn" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                                        <button @click.stop="removeBlock(index)" class="block-control-btn delete" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                                    </div>

                                    <!-- Block Render -->
                                    <div v-html="renderBlock(block)"></div>
                                </div>
                            </div>
                        </main>

                        <!-- Footer -->
                        <footer class="main-footer">
                            <div class="container">
                                <a href="#" class="logo">{{ globalSettings.footer.logoText }}</a>
                                <p>{{ globalSettings.footer.copyrightText }}</p>
                                <p v-if="globalSettings.footer.privacyLink">
                                    <a :href="globalSettings.footer.privacyLink">{{ globalSettings.footer.privacyLinkText }}</a>
                                </p>
                            </div>
                        </footer>
                    </div>
                </div>

                <!-- Right Panel - Settings -->
                <div class="settings-panel">
                    <div class="settings-tabs">
                        <button
                            class="settings-tab"
                            :class="{ active: activeTab === 'page' }"
                            @click="activeTab = 'page'"
                        >
                            –°—Ç—Ä–∞–Ω–∏—Ü–∞
                        </button>
                        <button
                            class="settings-tab"
                            :class="{ active: activeTab === 'block' }"
                            @click="activeTab = 'block'"
                        >
                            –ë–ª–æ–∫
                        </button>
                        <button
                            class="settings-tab"
                            :class="{ active: activeTab === 'global' }"
                            @click="activeTab = 'global'"
                        >
                            –ì–ª–æ–±–∞–ª—å–Ω—ã–µ
                        </button>
                    </div>

                    <!-- Page Settings Tab -->
                    <div v-if="activeTab === 'page'">
                        <h3 class="settings-title">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h3>

                        <div class="settings-group">
                            <label class="settings-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã *</label>
                            <input
                                v-model="pageData.title"
                                @input="onTitleChange"
                                class="settings-input"
                                type="text"
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"
                            >
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">
                                Slug (URL) *
                                <span v-if="autoGenerateSlug" style="color: var(--color-success); font-size: 0.75rem; margin-left: 0.5rem;">
                                    üîÑ –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞
                                </span>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input
                                    v-model="pageData.slug"
                                    @input="onSlugManualEdit"
                                    class="settings-input"
                                    type="text"
                                    placeholder="home"
                                    style="flex: 1;"
                                >
                                <button
                                    v-if="!autoGenerateSlug && pageData.title && pageData.status !== 'published'"
                                    @click="regenerateSlug"
                                    class="toolbar-btn save"
                                    type="button"
                                    title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å slug –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è"
                                    style="padding: 0.5rem 1rem; white-space: nowrap;"
                                >
                                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">
                                <span v-if="autoGenerateSlug">Slug –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è</span>
                                <span v-else>Slug –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "üîÑ –û–±–Ω–æ–≤–∏—Ç—å" —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è</span>
                            </small>
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">–¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
                            <select v-model="pageData.type" class="settings-input">
                                <option value="regular">–û–±—ã—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</option>
                                <option value="home">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</option>
                                <option value="article">–°—Ç–∞—Ç—å—è</option>
                                <option value="guide">–ì–∞–π–¥</option>
                            </select>
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">–°—Ç–∞—Ç—É—Å</label>
                            <div style="padding: 0.5rem; background: var(--bg-accent); border-radius: 6px; font-weight: 600;">
                                <span v-if="pageData.status === 'draft'" style="color: #f59e0b;">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                                <span v-if="pageData.status === 'published'" style="color: #10b981;">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                            </div>
                        </div>

                        <h3 class="settings-title" style="margin-top: 2rem;">SEO –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</h3>

                        <div class="settings-group">
                            <label class="settings-label">SEO Title</label>
                            <input
                                v-model="pageData.seoTitle"
                                class="settings-input"
                                type="text"
                                placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"
                            >
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">SEO Description</label>
                            <textarea
                                v-model="pageData.seoDescription"
                                class="settings-textarea"
                                rows="3"
                                placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º"
                            ></textarea>
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">SEO Keywords</label>
                            <input
                                v-model="pageData.seoKeywords"
                                class="settings-input"
                                type="text"
                                placeholder="–∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –±—Ä–∞–∑–∏–ª–∏—è, –º–µ–¥–∏—Ü–∏–Ω–∞"
                            >
                        </div>

                        <div v-if="currentPageId" style="margin-top: 2rem; padding: 1rem; background: var(--bg-accent); border-radius: 8px;">
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">
                                <strong>ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</strong> {{ currentPageId }}<br>
                                <strong>–†–µ–∂–∏–º:</strong> {{ isEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–°–æ–∑–¥–∞–Ω–∏–µ' }}
                            </small>
                        </div>
                        <!-- ========================= MENU SETTINGS ========================= -->
                        <h3 class="settings-title" style="margin-top: 2rem;">–ù–∞–≤–∏–≥–∞—Ü–∏—è (–º–µ–Ω—é)</h3>

                        <div class="settings-group">
                            <label class="settings-label">
                                <input type="checkbox" v-model="pageSettings.showInMenu" :disabled="pageData.status !== 'published'">
                                –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
                            </label>
                            <small class="settings-hint">
                                <span v-if="pageData.status !== 'published'" style="color: #dc3545;">‚ö†Ô∏è –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü</span>
                                <span v-else>‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –≤–µ—Ä—Ö–Ω–µ–º –º–µ–Ω—é —Å–∞–π—Ç–∞</span>
                            </small>
                        </div>

                        <div class="settings-group" v-if="pageSettings.showInMenu && pageData.status === 'published'">
                            <label class="settings-label">–ü–æ—Ä—è–¥–æ–∫ –≤ –º–µ–Ω—é</label>
                            <input type="number" v-model.number="pageSettings.menuPosition" class="settings-input" min="0" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
                            <small class="settings-hint">–ú–µ–Ω—å—à–µ–µ —á–∏—Å–ª–æ = –≤—ã—à–µ –≤ –º–µ–Ω—é (0 –∏–ª–∏ –ø—É—Å—Ç–æ = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è)</small>
                        </div>

                        <div class="settings-group" v-if="pageSettings.showInMenu && pageData.status === 'published'">
                            <label class="settings-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≤ –º–µ–Ω—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" v-model="pageSettings.menuTitle" class="settings-input" maxlength="80" placeholder="–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã">
                            <small class="settings-hint">–ï—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</small>
                        </div>

                        <div class="menu-preview" v-if="pageSettings.showInMenu && pageData.title">
                            <strong>–ü—Ä–µ–≤—å—é –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é:</strong>
                            <div class="preview-item">üìç {{ pageSettings.menuTitle || pageData.title }}</div>
                        </div>
                    </div>

                    <!-- Block Settings Tab -->
                    <div v-if="activeTab === 'block' && selectedBlock">
                        <div class="block-type-badge">
                            <span class="block-type-icon" v-html="getBlockIcon(selectedBlock.type)"></span>
                            <span class="block-type-name">{{ getBlockName(selectedBlock.type) }}</span>
                        </div>

                        <!-- Custom Block Name -->
                        <div class="settings-group" style="margin-top: 1.5rem;">
                            <label class="settings-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ (–∫–∞—Å—Ç–æ–º–Ω–æ–µ)</label>
                            <input
                                type="text"
                                v-model="selectedBlock.customName"
                                class="settings-input"
                                :placeholder="getBlockName(selectedBlock.type)"
                            >
                            <div class="settings-hint">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                        </div>

                        <!-- Dynamic Block Settings -->
                        <template v-for="(value, key) in selectedBlock.data" :key="key">
                            <!-- Simple Text/Number Fields -->
                            <div v-if="typeof value === 'string' || typeof value === 'number'" class="settings-group">
                                <label class="settings-label">{{ formatLabel(key) }}</label>
                                <input
                                    v-if="isDimensionKey(key)"
                                    type="text"
                                    v-model="selectedBlock.data[key]"
                                    class="settings-input"
                                >
                                <textarea
                                    v-else-if="isRichTextKey(key)"
                                    v-model="selectedBlock.data[key]"
                                    class="settings-textarea"
                                    rows="4"
                                ></textarea>
                                <div v-else-if="isImageKey(key)" style="display: flex; gap: 0.5rem;">
                                    <input
                                        type="text"
                                        v-model="selectedBlock.data[key]"
                                        class="settings-input"
                                        style="flex: 1;"
                                    >
                                    <button
                                        @click="openGallery(key)"
                                        style="padding: 0.75rem 1rem; background: var(--color-action); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; flex-shrink: 0;"
                                        title="–í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏"
                                    >
                                        üìÅ
                                    </button>
                                </div>
                                <input
                                    v-else
                                    type="text"
                                    v-model="selectedBlock.data[key]"
                                    class="settings-input"
                                >
                            </div>

                            <!-- Array Fields (Cards, Paragraphs, etc.) -->
                            <div v-else-if="Array.isArray(value)" class="settings-group">
                                <label class="settings-label">{{ formatLabel(key) }}</label>

                                <!-- Array of Strings (e.g., paragraphs) -->
                                <template v-if="value.length > 0 && typeof value[0] === 'string'">
                                    <div v-for="(item, index) in value" :key="index" style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <strong style="font-size: 0.85rem; color: var(--text-dark);">{{ formatLabel(key) }} #{{ index + 1 }}</strong>
                                            <button
                                                @click="removeArrayItem(key, index)"
                                                style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                                            >
                                                –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>
                                        <textarea
                                            v-model="value[index]"
                                            class="settings-input"
                                            style="min-height: 80px; font-size: 0.8rem;"
                                        ></textarea>
                                    </div>
                                </template>

                                <!-- Array of Objects (e.g., cards, messages) -->
                                <template v-else>
                                    <div v-for="(item, index) in value" :key="index" style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <strong style="font-size: 0.85rem; color: var(--text-dark);">{{ formatLabel(key) }} #{{ index + 1 }}</strong>
                                            <button
                                                @click="removeArrayItem(key, index)"
                                                style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                                            >
                                                –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>

                                        <template v-for="(itemValue, itemKey) in item" :key="itemKey">
                                            <div style="margin-bottom: 0.5rem;">
                                                <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                                                    {{ formatLabel(itemKey) }}
                                                </label>
                                                <textarea
                                                    v-if="itemKey === 'icon' || itemKey === 'answer' || itemKey === 'text'"
                                                    v-model="item[itemKey]"
                                                    class="settings-input"
                                                    style="min-height: 60px; font-size: 0.8rem;"
                                                ></textarea>
                                                <div v-else-if="isImageKey(itemKey)" style="display: flex; gap: 0.5rem;">
                                                    <input
                                                        type="text"
                                                        v-model="item[itemKey]"
                                                        class="settings-input"
                                                        style="font-size: 0.8rem; flex: 1;"
                                                    >
                                                    <button
                                                        @click="openGalleryForArrayItem(key, index, itemKey)"
                                                        style="padding: 0.5rem 0.75rem; background: var(--color-action); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; flex-shrink: 0;"
                                                        title="–í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏"
                                                    >
                                                        üìÅ
                                                    </button>
                                                </div>
                                                <input
                                                    v-else
                                                    type="text"
                                                    v-model="item[itemKey]"
                                                    class="settings-input"
                                                    style="font-size: 0.8rem;"
                                                >
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <button
                                    @click="addArrayItem(key)"
                                    style="width: 100%; padding: 0.5rem; background: var(--color-action); color: white; border: none; border-radius: 6px; cursor: pointer; font-family: var(--font-heading); font-weight: 600; font-size: 0.85rem;"
                                >
                                    + –î–æ–±–∞–≤–∏—Ç—å {{ formatLabel(key) }}
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- Global Settings Tab -->
                    <div v-if="activeTab === 'global'">
                        <h3 class="settings-title">Header</h3>

                        <div class="settings-group">
                            <label class="settings-label">–õ–æ–≥–æ—Ç–∏–ø</label>
                            <input v-model="globalSettings.header.logoText" class="settings-input" type="text">
                        </div>

                        <h3 class="settings-title" style="margin-top: 2rem;">Footer</h3>

                        <div class="settings-group">
                            <label class="settings-label">–õ–æ–≥–æ—Ç–∏–ø</label>
                            <input v-model="globalSettings.footer.logoText" class="settings-input" type="text">
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">Copyright —Ç–µ–∫—Å—Ç</label>
                            <input v-model="globalSettings.footer.copyrightText" class="settings-input" type="text">
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">–°—Å—ã–ª–∫–∞ –Ω–∞ Privacy Policy</label>
                            <input v-model="globalSettings.footer.privacyLink" class="settings-input" type="text" placeholder="#privacy">
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">–¢–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏ Privacy</label>
                            <input v-model="globalSettings.footer.privacyLinkText" class="settings-input" type="text">
                        </div>

                        <h3 class="settings-title" style="margin-top: 2rem;">Cookie Banner</h3>

                        <div class="settings-group">
                            <label class="settings-label">
                                <input type="checkbox" v-model="globalSettings.cookieBanner.enabled"> –í–∫–ª—é—á–∏—Ç—å Cookie Banner
                            </label>
                        </div>

                        <div v-if="globalSettings.cookieBanner.enabled">
                            <div class="settings-group">
                                <label class="settings-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                                <textarea v-model="globalSettings.cookieBanner.message" class="settings-textarea" rows="3"></textarea>
                            </div>

                            <div class="settings-group">
                                <label class="settings-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å"</label>
                                <input v-model="globalSettings.cookieBanner.acceptText" class="settings-input" type="text">
                            </div>

                            <div class="settings-group">
                                <label class="settings-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"</label>
                                <input v-model="globalSettings.cookieBanner.detailsText" class="settings-input" type="text">
                            </div>
                        </div>
                    </div>

                    <div v-if="activeTab === 'block' && !selectedBlock" class="empty-state" style="padding: 4rem 1rem;">
                        <div class="empty-icon" style="font-size: 3rem;">üëà</div>
                        <p style="font-size: 0.875rem;">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Modal -->
        <div v-if="showTemplatesModal" class="modal-overlay" @click.self="showTemplatesModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
                    <p>–ì–æ—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ - –ø—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏—Ç–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</p>
                </div>

                <div class="modal-body">
                    <div class="templates-grid">
                        <div
                            v-for="template in pageTemplates"
                            :key="template.id"
                            @click="applyTemplate(template)"
                            class="template-card"
                        >
                            <div class="template-preview">{{ template.preview }}</div>
                            <h3 class="template-name">{{ template.name }}</h3>
                            <p class="template-desc">{{ template.description }}</p>
                            <div class="template-blocks-count">{{ template.blocks.length }} –±–ª–æ–∫–æ–≤</div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button @click="showTemplatesModal = false" class="modal-btn-cancel">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- Gallery Modal -->
        <div v-if="showGalleryModal" class="modal-overlay gallery-overlay" @click.self="showGalleryModal = false">
            <div class="modal-content gallery-modal">
                <div class="modal-header" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div>
                            <h2>–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö</p>
                        </div>
                        <button
                            @click="openMediaLibrary"
                            style="padding: 0.65rem 1.1rem; border-radius: 8px; border: 1px solid rgba(3, 42, 73, 0.15); background: white; color: var(--color-action); font-family: var(--font-heading); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem;"
                            type="button"
                        >
                            üîó –û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–∏–∞—Ç–µ–∫—É
                        </button>
                    </div>
                </div>

                <div class="modal-body">
                    <!-- Upload Area -->
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; width: 100%; padding: 2rem; border: 2px dashed var(--color-action); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(0, 141, 141, 0.03);">
                            <input type="file" @change="handleFileUpload" accept="image/*" style="display: none;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì§</div>
                            <div style="font-family: var(--font-heading); font-weight: 600; color: var(--color-action); margin-bottom: 0.25rem;">
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª (–º–∞–∫—Å. 5MB)
                            </div>
                        </label>
                        <div v-if="uploadProgress" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--color-action);">
                            {{ uploadProgress }}
                        </div>
                    </div>

                    <!-- Gallery Grid -->
                    <div v-if="galleryImages.length > 0">
                        <h3 style="font-family: var(--font-heading); font-size: 1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1rem;">
                            –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ({{ galleryImages.length }})
                        </h3>
                        <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                            <div
                                v-for="image in galleryImages"
                                :key="image.id"
                                class="image-card"
                                @click="selectImageFromGallery(image)"
                                style="position: relative; aspect-ratio: 1; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; display:flex; flex-direction:column;"
                                :style="{ borderColor: selectedGalleryImage && selectedGalleryImage.id === image.id ? 'var(--color-action)' : 'transparent' }"
                                @mouseenter="$event.currentTarget.style.transform = 'scale(1.02)'"
                                @mouseleave="$event.currentTarget.style.transform = 'scale(1)'"
                            >
                                <img :src="image.displayUrl" :alt="image.filename" style="width: 100%; height: calc(100% - 40px); object-fit: cover; display:block;">
                                <div class="image-caption">{{ image.filename }}</div>
                                <button
                                    @click.stop="deleteImage(image)"
                                    style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(220, 38, 38, 0.9); color: white; border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease; opacity: 0;"
                                    @mouseenter="$event.currentTarget.style.opacity = '1'"
                                    @mouseleave="$event.currentTarget.style.opacity = '0'"
                                    title="–£–¥–∞–ª–∏—Ç—å"
                                >
                                    üóë
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-else style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üñº</div>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                        <p style="font-size: 0.875rem;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—à–µ</p>
                    </div>
                </div>

                <div class="modal-footer">
                    <button @click="showGalleryModal = false" class="modal-btn-cancel">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                    <button
                        v-if="selectedGalleryImage"
                        @click="confirmImageSelection"
                        style="padding: 0.75rem 1.5rem; background: var(--color-action); color: white; border: none; border-radius: 8px; font-family: var(--font-heading); font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-left: 0.5rem;"
                    >
                        –í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>

        <!-- Article Editor Mode -->
        <div v-if="showArticleEditor" class="article-editor-mode">
            <div class="article-editor-toolbar">
                <div class="article-editor-title">‚úçÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç–µ–π</div>
                <div class="article-editor-actions">
                    <button @click="closeArticleEditor" class="article-editor-btn close">
                        ‚Üê –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                    <button @click="saveArticleAndClose" class="article-editor-btn save">
                        ‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
            <div class="article-editor-container">
                <div class="article-editor-wrapper">
                    <div id="quill-editor"></div>
                </div>
            </div>
        </div>

        <!-- Block Preview Modal -->
        <div v-if="previewBlock" class="block-preview-modal" @click.self="previewBlock = null">
            <div class="block-preview-content">
                <div class="block-preview-header">
                    <div class="block-preview-title">
                        <span style="margin-right: 0.5rem;" v-html="previewBlock.icon"></span>
                        {{ previewBlock.name }}
                    </div>
                    <button @click="previewBlock = null" class="block-preview-close">‚úï</button>
                </div>
                <div class="block-preview-body" v-html="renderPreviewBlock()"></div>
            </div>
        </div>

        <!-- Login Modal -->
        <div v-if="showLoginModal" class="modal-overlay" style="z-index: 9999;">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2>–í—Ö–æ–¥ –≤ CMS</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É</p>
                </div>

                <div class="modal-body">
                    <div class="settings-group">
                        <label class="settings-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input
                            v-model="loginForm.username"
                            @keyup.enter="login"
                            class="settings-input"
                            type="text"
                            placeholder="anna"
                            autofocus
                        >
                    </div>

                    <div class="settings-group">
                        <label class="settings-label">–ü–∞—Ä–æ–ª—å</label>
                        <input
                            v-model="loginForm.password"
                            @keyup.enter="login"
                            class="settings-input"
                            type="password"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        >
                    </div>
                </div>

                <div class="modal-footer">
                    <button
                        @click="login"
                        style="width: 100%; padding: 0.75rem 1.5rem; background: var(--color-action); color: white; border: none; border-radius: 8px; font-family: var(--font-heading); font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                    >
                        üîê –í–æ–π—Ç–∏
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div
            v-if="debugPanelEnabled"
            class="debug-panel"
            :class="{ collapsed: debugPanelCollapsed }"
        >
            <div class="debug-panel-header">
                <div class="debug-panel-title">
                    üõ† Debug Panel
                    <span style="font-size: 0.7rem; opacity: 0.65;">{{ debugMessages.length }} —Å–æ–±—ã—Ç–∏–π</span>
                </div>
                <div class="debug-panel-actions">
                    <button class="debug-panel-button" @click="clearDebugLog" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <button class="debug-panel-button" @click="toggleDebugPanel" type="button">
                        {{ debugPanelCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å' : '–°–∫—Ä—ã—Ç—å' }}
                    </button>
                </div>
            </div>
            <div class="debug-panel-body" ref="debugPanelBody">
                <div v-if="debugMessages.length === 0" class="debug-panel-empty">
                    –õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
                </div>
                <div
                    v-for="msg in debugMessages"
                    :key="msg.id"
                    class="debug-message"
                    :class="msg.type"
                >
                    <div class="debug-message-header">
                        <span>{{ msg.time }}</span>
                        <span>{{ msg.type.toUpperCase() }}</span>
                    </div>
                    <div class="debug-message-text">{{ msg.message }}</div>
                    <pre v-if="msg.payload" class="debug-message-payload">{{ msg.payload }}</pre>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div
            v-if="notification"
            class="notification"
            :class="{ 'error': notification.type === 'error' }"
            :style="notificationStyle"
        >
            {{ notification.message }}
        </div>
    </div>

    <script type="module" src="editor.js?v=1.3"></script>
</body>
</html>
