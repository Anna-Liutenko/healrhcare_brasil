<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–¥–∏–∞-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ - Healthcare CMS</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="media-library.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1>üìÅ –ú–µ–¥–∏–∞-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
            </div>
            <div class="header-right">
                <span class="user-info">{{ currentUser?.username || 'Guest' }}</span>
                <button @click="logout" class="btn-logout">–í—ã—Ö–æ–¥</button>
            </div>
        </header>

        <!-- Navigation (trimmed) -->
        <nav class="admin-nav">
            <!-- Removed '–ú–µ–¥–∏–∞' nav link per user request; kept navigation minimal -->
        </nav>

        <!-- Main Content -->
        <main class="media-library-container">
            
            <!-- Toolbar -->
            <div class="media-toolbar">
                <div class="toolbar-left">
                    <button @click="triggerFileInput" class="btn-primary">
                        üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                    </button>
                    <input 
                        type="file" 
                        ref="fileInput" 
                        @change="handleFileSelect"
                        accept="image/*,.svg"
                        style="display: none;"
                        multiple
                    >
                    
                    <!-- Filters simplified: removed tab buttons per UI cleanup request -->
                </div>

                <div class="toolbar-right">
                    <input 
                        type="search" 
                        v-model="searchQuery"
                        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..."
                        class="search-input"
                    >
                </div>
            </div>

            <!-- Upload Progress -->
            <div v-if="uploadProgress > 0 && uploadProgress < 100" class="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" :style="{width: uploadProgress + '%'}"></div>
                </div>
                <span class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞: {{ uploadProgress }}%</span>
            </div>

            <!-- Drop Zone -->
            <div 
                v-if="mediaFiles.length === 0 && !isLoading"
                class="drop-zone"
                @dragover.prevent="isDragging = true"
                @dragleave.prevent="isDragging = false"
                @drop.prevent="handleDrop"
                :class="{dragging: isDragging}"
            >
                <div class="drop-zone-content">
                    <div class="drop-icon">üìÅ</div>
                    <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</h3>
                    <p>–∏–ª–∏</p>
                    <button @click="triggerFileInput" class="btn-primary">
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                    </button>
                    <p class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, SVG</p>
                </div>
            </div>

            <!-- Loading -->
            <div v-if="isLoading" class="loading-state">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤...</p>
            </div>

            <!-- Error -->
            <div v-if="error" class="error-message">
                ‚ö†Ô∏è {{ error }}
                <button @click="loadMedia" class="btn-retry">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>

            <!-- Media Grid -->
            <div v-if="!isLoading && filteredFiles.length > 0" class="media-grid">
                <div 
                    v-for="file in filteredFiles" 
                    :key="file.id"
                    class="media-item"
                    @click="selectFile(file)"
                >
                    <!-- Preview -->
                    <div class="media-preview">
                        <img 
                            v-if="file.type === 'image'" 
                            :src="getFileUrl(file.url)" 
                            :alt="file.filename"
                            :data-file-url="file.url"
                            :data-filename="file.filename"
                            @error="handleImageError"
                        >
                        <div v-else class="file-icon">üìÑ</div>
                    </div>

                    <!-- Info -->
                    <div class="media-info">
                        <div class="media-filename" :title="file.filename">
                            {{ file.filename }}
                        </div>
                        <div class="media-meta">
                            <span class="file-size">{{ file.human_size }}</span>
                            <span class="file-date">{{ formatDate(file.uploaded_at) }}</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="media-actions">
                        <button 
                            @click.stop="copyUrl(file)"
                            class="btn-icon"
                            title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL"
                        >
                            üìã
                        </button>
                        <button 
                            @click.stop="deleteFile(file)"
                            class="btn-icon btn-danger"
                            title="–£–¥–∞–ª–∏—Ç—å"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-if="!isLoading && filteredFiles.length === 0 && mediaFiles.length > 0" class="empty-state">
                <p>–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É "{{ searchQuery }}"</p>
            </div>

        </main>

        <!-- Delete Confirmation Modal -->
        <div v-if="fileToDelete" class="modal-overlay" @click="cancelDelete">
            <div class="modal-dialog" @click.stop>
                <div class="modal-header">
                    <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
                    <button @click="cancelDelete" class="btn-close">√ó</button>
                </div>
                <div class="modal-body">
                    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?</p>
                    <p class="file-name">{{ fileToDelete.filename }}</p>
                    <p class="warning">‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
                </div>
                <div class="modal-footer">
                    <button @click="cancelDelete" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="confirmDelete" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Success Toast -->
        <div v-if="successMessage" class="toast toast-success">
            ‚úÖ {{ successMessage }}
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script type="module" src="media-library.js"></script>
</body>
</html>
