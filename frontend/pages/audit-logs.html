<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞ - Healthcare Brazil CMS</title>

    <link rel="stylesheet" href="../styles/main.css" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            font-family: var(--font-heading);
        }

        [v-cloak] { display: none; }

        .audit-logs-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .audit-header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .audit-header h1 {
            margin: 0 0 20px 0;
            font-size: 28px;
            color: #333;
        }

        .audit-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .audit-search {
            flex: 1;
            min-width: 250px;
        }

        .audit-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .audit-search input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .audit-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .audit-actions {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            padding: 10px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export:hover {
            background: #e8e8e8;
            border-color: #ccc;
        }

        .btn-refresh {
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-refresh:active {
            transform: translateY(0);
        }

        .btn-refresh.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .audit-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .audit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .audit-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .audit-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
        }

        .audit-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }

        .audit-table tbody tr:hover {
            background: #f8f9fa;
        }

        .audit-table td {
            padding: 12px 15px;
            color: #666;
        }

        .audit-action-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-create {
            background: #c3fae8;
            color: #2b8a3e;
        }

        .action-update {
            background: #bfefff;
            color: #0055b8;
        }

        .action-delete {
            background: #ffe0e0;
            color: #c92a2a;
        }

        .action-login {
            background: #fff3bf;
            color: #856404;
        }

        .action-logout {
            background: #f1f3f5;
            color: #495057;
        }

        .severity-critical {
            color: #c92a2a;
            font-weight: 600;
        }

        .severity-high {
            color: #f59f00;
            font-weight: 600;
        }

        .severity-medium {
            color: #1971c2;
        }

        .severity-low {
            color: #757575;
        }

        .audit-timestamp {
            color: #999;
            white-space: nowrap;
            font-size: 12px;
        }

        .audit-ip {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #666;
        }

        .audit-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .audit-loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e9ecef;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.6s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .audit-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .audit-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .audit-pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #555;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            padding: 8px 12px;
            color: #666;
            font-size: 13px;
            white-space: nowrap;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease-out;
            z-index: 1000;
        }

        .notification.success {
            border-left: 4px solid #48bb78;
            color: #22543d;
        }

        .notification.error {
            border-left: 4px solid #f56565;
            color: #742a2a;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .audit-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .audit-filters {
                flex-direction: column;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group select {
                width: 100%;
            }

            .audit-table {
                font-size: 12px;
            }

            .audit-table th,
            .audit-table td {
                padding: 8px 10px;
            }

            .audit-pagination {
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body v-cloak>

<div id="app">
    <!-- Back link -->
    <div class="audit-logs-container" style="padding-top: 10px; padding-bottom: 0;">
        <a href="index.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
    </div>

    <!-- Header -->
    <div class="audit-logs-container">
        <div class="audit-header">
            <h1>üìã –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞</h1>
            
            <div class="audit-controls">
                <div class="audit-search">
                    <input 
                        type="text" 
                        v-model="searchQuery"
                        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –¥–µ–π—Å—Ç–≤–∏—é, IP...">
                </div>

                <div class="audit-filters">
                    <div class="filter-group">
                        <label for="filter-action">–î–µ–π—Å—Ç–≤–∏–µ:</label>
                        <select id="filter-action" v-model="filterAction">
                            <option value="">–í—Å–µ</option>
                            <option value="CREATE">–°–æ–∑–¥–∞–Ω–∏–µ</option>
                            <option value="UPDATE">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</option>
                            <option value="DELETE">–£–¥–∞–ª–µ–Ω–∏–µ</option>
                            <option value="LOGIN">–í—Ö–æ–¥</option>
                            <option value="LOGOUT">–í—ã—Ö–æ–¥</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-severity">–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:</label>
                        <select id="filter-severity" v-model="filterSeverity">
                            <option value="">–í—Å–µ</option>
                            <option value="CRITICAL">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è</option>
                            <option value="HIGH">–í—ã—Å–æ–∫–∞—è</option>
                            <option value="MEDIUM">–°—Ä–µ–¥–Ω—è—è</option>
                            <option value="LOW">–ù–∏–∑–∫–∞—è</option>
                        </select>
                    </div>
                </div>

                <div class="audit-actions">
                    <button class="btn-export" @click="exportLogs" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ CSV">
                        üì• CSV
                    </button>
                    <button 
                        class="btn-refresh" 
                        @click="loadAuditLogs"
                        :class="{ loading: isLoading }"
                        :disabled="isLoading"
                        title="–û–±–Ω–æ–≤–∏—Ç—å">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="audit-logs-container">
        <div class="audit-table-container">
            <div v-if="isLoading" class="audit-loading">
                <div class="audit-loading-spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞...
            </div>

            <div v-else-if="filteredLogs.length === 0" class="audit-empty">
                <div class="audit-empty-icon">üì≠</div>
                <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª–µ –∞—É–¥–∏—Ç–∞</p>
            </div>

            <table v-else class="audit-table">
                <thead>
                    <tr>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        <th>–†–µ—Å—É—Ä—Å</th>
                        <th>–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å</th>
                        <th>IP –∞–¥—Ä–µ—Å</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="log in paginatedLogs" :key="log.id">
                        <td class="audit-timestamp">{{ formatDate(log.timestamp) }}</td>
                        <td>{{ log.username || log.user_id || '‚Äî' }}</td>
                        <td>
                            <span :class="`audit-action-badge action-${log.action.toLowerCase()}`">
                                {{ translateAction(log.action) }}
                            </span>
                        </td>
                        <td>{{ log.resource_type }} #{{ log.resource_id }}</td>
                        <td>
                            <span :class="`severity-${log.severity}`">
                                {{ translateSeverity(log.severity) }}
                            </span>
                        </td>
                        <td class="audit-ip">{{ log.ip_address }}</td>
                        <td style="color: #667eea; cursor: pointer;" @click="showDetails(log)">
                            {{ log.details ? '–ü–æ–∫–∞–∑–∞—Ç—å' : '‚Äî' }}
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div v-if="filteredLogs.length > 0" class="audit-pagination">
                <button 
                    class="pagination-btn"
                    @click="currentPage = 1"
                    :disabled="currentPage === 1">
                    ¬´ –ü–µ—Ä–≤–∞—è
                </button>

                <button 
                    class="pagination-btn"
                    @click="currentPage--"
                    :disabled="currentPage === 1">
                    ‚Äπ –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                </button>

                <div class="pagination-info">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ currentPage }} –∏–∑ {{ totalPages }}
                </div>

                <button 
                    class="pagination-btn"
                    @click="currentPage++"
                    :disabled="currentPage === totalPages">
                    –°–ª–µ–¥—É—é—â–∞—è ‚Ä∫
                </button>

                <button 
                    class="pagination-btn"
                    @click="currentPage = totalPages"
                    :disabled="currentPage === totalPages">
                    –ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div v-if="notification" :class="`notification ${notification.type}`">
        {{ notification.message }}
    </div>
</div>

<script type="module">
import ApiClient from '../api-client.js';
import '../js/error-handler.js';

const { createApp } = Vue;

createApp({
    data() {
        return {
            apiClient: null,
            auditLogs: [],
            filteredLogs: [],
            isLoading: true,
            searchQuery: '',
            filterAction: '',
            filterSeverity: '',
            currentPage: 1,
            pageSize: 20,
            notification: null,
        };
    },

    computed: {
        totalPages() {
            return Math.ceil(this.filteredLogs.length / this.pageSize);
        },

        paginatedLogs() {
            const start = (this.currentPage - 1) * this.pageSize;
            const end = start + this.pageSize;
            return this.filteredLogs.slice(start, end);
        }
    },

    watch: {
        searchQuery() {
            this.currentPage = 1;
            this.applyFilters();
        },

        filterAction() {
            this.currentPage = 1;
            this.applyFilters();
        },

        filterSeverity() {
            this.currentPage = 1;
            this.applyFilters();
        }
    },

    methods: {
        async loadAuditLogs() {
            this.isLoading = true;
            try {
                const response = await this.apiClient.getAuditLogs({
                    limit: 1000,
                    offset: 0
                });

                this.auditLogs = response.data || response || [];
                this.applyFilters();
                this.showNotification('–õ–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
            } catch (error) {
                console.error('Error loading audit logs:', error);
                this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ' + error.message, 'error');
            } finally {
                this.isLoading = false;
            }
        },

        applyFilters() {
            let filtered = this.auditLogs;

            // Search filter
            if (this.searchQuery) {
                const q = this.searchQuery.toLowerCase();
                filtered = filtered.filter(log => {
                    return (log.username && log.username.toLowerCase().includes(q)) ||
                           (log.action && log.action.toLowerCase().includes(q)) ||
                           (log.ip_address && log.ip_address.includes(q)) ||
                           (log.resource_type && log.resource_type.toLowerCase().includes(q));
                });
            }

            // Action filter
            if (this.filterAction) {
                filtered = filtered.filter(log => log.action === this.filterAction);
            }

            // Severity filter
            if (this.filterSeverity) {
                filtered = filtered.filter(log => log.severity === this.filterSeverity);
            }

            this.filteredLogs = filtered;
        },

        formatDate(dateString) {
            if (!dateString) return '‚Äî';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        },

        translateAction(action) {
            const translations = {
                'CREATE': '‚ûï –°–æ–∑–¥–∞–Ω–æ',
                'UPDATE': '‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–æ',
                'DELETE': 'üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ',
                'LOGIN': 'üîì –í—Ö–æ–¥',
                'LOGOUT': 'üîí –í—ã—Ö–æ–¥'
            };
            return translations[action] || action;
        },

        translateSeverity(severity) {
            const translations = {
                'CRITICAL': 'üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è',
                'HIGH': 'üü† –í—ã—Å–æ–∫–∞—è',
                'MEDIUM': 'üü° –°—Ä–µ–¥–Ω—è—è',
                'LOW': 'üü¢ –ù–∏–∑–∫–∞—è'
            };
            return translations[severity] || severity;
        },

        showDetails(log) {
            if (log.details) {
                alert('–î–µ—Ç–∞–ª–∏:\n' + (typeof log.details === 'string' ? log.details : JSON.stringify(log.details, null, 2)));
            }
        },

        exportLogs() {
            if (this.filteredLogs.length === 0) {
                this.showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }

            const headers = ['–í—Ä–µ–º—è', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–î–µ–π—Å—Ç–≤–∏–µ', '–†–µ—Å—É—Ä—Å', '–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å', 'IP –∞–¥—Ä–µ—Å'];
            const rows = this.filteredLogs.map(log => [
                this.formatDate(log.timestamp),
                log.username || log.user_id || '‚Äî',
                this.translateAction(log.action),
                `${log.resource_type} #${log.resource_id}`,
                this.translateSeverity(log.severity),
                log.ip_address
            ]);

            // Create CSV content
            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `audit-logs-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            this.showNotification('–õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        },

        showNotification(message, type) {
            this.notification = { message, type };
            setTimeout(() => {
                this.notification = null;
            }, 3000);
        }
    },

    async mounted() {
        this.apiClient = new ApiClient();
        await this.loadAuditLogs();
    }
}).mount('#app');
</script>

</body>
</html>
